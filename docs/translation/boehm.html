<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-translation/boehm">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Danyow RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Danyow Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Danyow JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-141789564-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-141789564-1",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Danyow" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/changelog/rss.xml" title="æ—¥å¿— RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/changelog/atom.xml" title="æ—¥å¿— Atom Feed">
<link rel="alternate" type="application/json" href="/changelog/feed.json" title="æ—¥å¿— JSON Feed">
<link rel="icon" href="/img/logo.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/logo.png">
<link rel="mask-icon" href="/img/logo.png" color="rgb(62, 204, 94)">
<meta name="msapplication-TileImage" content="/img/logo.png">
<meta name="msapplication-TileColor" content="#000">
<link rel="stylesheet" href="/katex/katex.min.css"><title data-rh="true">Boehmåƒåœ¾å›æ”¶ | Danyow</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://danyow.github.io/docs/translation/boehm"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Boehmåƒåœ¾å›æ”¶ | Danyow"><meta data-rh="true" name="description" content="Slideå¹»ç¯ç‰‡åœ°å€"><meta data-rh="true" property="og:description" content="Slideå¹»ç¯ç‰‡åœ°å€"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://danyow.github.io/docs/translation/boehm"><link data-rh="true" rel="alternate" href="https://danyow.github.io/docs/translation/boehm" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://danyow.github.io/en/docs/translation/boehm" hreflang="en"><link data-rh="true" rel="alternate" href="https://danyow.github.io/docs/translation/boehm" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://S3KRFC060Q-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.bff76bc0.css">
<link rel="preload" href="/assets/js/runtime~main.143b31b0.js" as="script">
<link rel="preload" href="/assets/js/main.cabcfe72.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_BxGa">è·³åˆ°ä¸»è¦å†…å®¹</a></div><div class="announcementBar_yyVl" role="banner"><div class="announcementBarPlaceholder_Il1w"></div><div class="announcementBarContent_KFU1">â­ï¸ <a target="_blank" rel="noopener noreferrer" href="https://github.com/danyow/danyow.github.io">å¦‚å–œ, èµæ˜Ÿ</a>  â­ï¸</div><button type="button" class="clean-btn close announcementBarClose_axA0" aria-label="å…³é—­"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_FcXi"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Danyow Logo" class="themedImage_aIr_ themedImage--light_DGIu" height="32" width="32"><img src="/img/logo-dark.svg" alt="Danyow Logo" class="themedImage_aIr_ themedImage--dark_RoHN" height="32" width="32"></div><b class="navbar__title">Danyow</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs">å‚¨å¤‡</a><a class="navbar__item navbar__link" href="/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/changelog">æ—¥å¿—</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs">v0 ğŸš§</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/translation/boehm">v0 ğŸš§</a></li><li><a href="https://danyow-jbufheovr-danyow.vercel.app/docs/unity-manual/unity-manual" target="_blank" rel="noopener noreferrer" class="dropdown__link">Unity@2022.1<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_GWqj"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://danyow-n1bljgzah-danyow.vercel.app/docs/lua/hello" target="_blank" rel="noopener noreferrer" class="dropdown__link">Lua@5.3<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_GWqj"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/versions">æ‰€æœ‰ç‰ˆæœ¬</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_NpMu"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/docs/translation/boehm" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">ä¸­æ–‡</a></li><li><a href="/en/docs/translation/boehm" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="https://github.com/danyow/danyow.github.io/issues/3526" target="_blank" rel="noopener noreferrer" class="dropdown__link">Help Us Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_GWqj"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/danyow/danyow.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_IT2h colorModeToggle_o_qc"><button class="clean-btn toggleButton_pGki toggleButtonDisabled_vZLo" type="button" disabled="" title="åˆ‡æ¢æµ…è‰²/æš—é»‘æ¨¡å¼ï¼ˆå½“å‰ä¸ºæµ…è‰²æ¨¡å¼ï¼‰" aria-label="åˆ‡æ¢æµ…è‰²/æš—é»‘æ¨¡å¼ï¼ˆå½“å‰ä¸ºæµ…è‰²æ¨¡å¼ï¼‰"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_dYsV"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_WRF1"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_lGmL"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_zNSk"><button aria-label="å›åˆ°é¡¶éƒ¨" class="clean-btn theme-back-to-top-button backToTopButton_ecpa" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_NEdF"><div class="sidebar_Uz2u sidebarWithHideableNavbar_MFe1"><a tabindex="-1" class="sidebarLogo_iqfm" href="/"><img src="/img/logo.svg" alt="Danyow Logo" class="themedImage_aIr_ themedImage--light_DGIu" height="32" width="32"><img src="/img/logo-dark.svg" alt="Danyow Logo" class="themedImage_aIr_ themedImage--dark_RoHN" height="32" width="32"><b>Danyow</b></a><nav class="menu thin-scrollbar menu_XU2j menuWithAnnouncementBar_vo3y"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/audition">å…«è‚¡</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€Œå…«è‚¡ã€" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/glossary">æœ¯è¯­è¡¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs">å ä½ç¬¦</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/reprint">è½¬è½½</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€Œè½¬è½½ã€" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/translation">ç¿»è¯‘</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€Œç¿»è¯‘ã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/translation/boehm">Boehmåƒåœ¾å›æ”¶</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/translation/luagc">Luaçš„åƒåœ¾å›æ”¶</a></li></ul></li></ul></nav><button type="button" title="æ”¶èµ·ä¾§è¾¹æ " aria-label="æ”¶èµ·ä¾§è¾¹æ " class="button button--secondary button--outline collapseSidebarButton_Essf"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_bqna"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_vJqy"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_ygLL"><div class="docItemContainer_yJzi"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_nmcO" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">ğŸ </a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/translation"><span itemprop="name">ç¿»è¯‘</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">Boehmåƒåœ¾å›æ”¶</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_aX8Q theme-doc-toc-mobile tocMobile_By44"><button type="button" class="clean-btn tocCollapsibleButton_Va7b">æœ¬é¡µæ€»è§ˆ</button></div><div class="theme-doc-markdown markdown"><h1>The &quot;Boehm-Demers-Weiser&quot; Conservative Garbage Collector</h1><blockquote><p><a href="https://www.hboehm.info/gc/04tutorial.pdf" target="_blank" rel="noopener noreferrer">Slideå¹»ç¯ç‰‡åœ°å€</a></p></blockquote><blockquote><p><a href="https://dl.acm.org/doi/pdf/10.1145/96709.96735" target="_blank" rel="noopener noreferrer">è®ºæ–‡åœ°å€</a></p></blockquote><blockquote><p><a href="https://www.hboehm.info/" target="_blank" rel="noopener noreferrer">å¤§ä½¬ä¸»é¡µ</a></p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="outline">Outline<a class="hash-link" href="#outline" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Introduction<ul><li>Interface</li><li>Implementation basics &amp; goals</li></ul></li><li>Implementation details and issues<ul><li>Core collector</li><li>Enhancements</li></ul></li><li>Experiences and a few measurements</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="æ¦‚è¿°">æ¦‚è¿°<a class="hash-link" href="#æ¦‚è¿°" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>å¯¼è¨€<ul><li>æ¥å£</li><li>å®ç°åŸºç¡€ä¸ç›®æ ‡</li></ul></li><li>å®ç°ç»†èŠ‚å’Œé—®é¢˜<ul><li>æ ¸å¿ƒå›æ”¶å™¨</li><li>å¢å¼ºåŠŸèƒ½</li></ul></li><li>ç»éªŒå’Œä¸€äº›æµ‹è¯•</li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="what-is-it">What is it?<a class="hash-link" href="#what-is-it" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>A garbage collecting replacement for C&#x27;s malloc().<ul><li>Calls to free() are optional.</li><li>Unreachable memory is automatically reclaimed, and made available to future
malloc() calls.</li></ul></li><li>A tracing (mark/sweep) garbage collector.<ul><li>It periodically determines which objects can be reached by following pointers.</li><li>The rest can be reused for other purposes.</li></ul></li><li>An easy way to add garbage collection to a runtime system.<ul><li>Easy to interface to.</li><li>Interacts well with C/C++ code.</li><li>Gcj (Java), Mono (C#, .NET), Bigloo (Scheme), MzScheme.</li></ul></li><li>A leak detector for programs that call free().<ul><li>Unreachable unfreed memory is a memory leak.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="ä»–æ˜¯ä»€ä¹ˆ">ä»–æ˜¯ä»€ä¹ˆï¼Ÿ<a class="hash-link" href="#ä»–æ˜¯ä»€ä¹ˆ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>ä¸€ä¸ªå¯ä»¥æ›¿ä»£<code>C</code>ä¸­<code>malloc()</code>çš„åƒåœ¾å›æ”¶å™¨ã€‚<ul><li>å¯¹<code>free()</code>çš„è°ƒç”¨æ˜¯å¯é€‰çš„ã€‚</li><li>ä¸å¯è¾¾å†…å­˜ä¼šè‡ªåŠ¨å›æ”¶ï¼Œå¹¶æä¾›ç‰¹æ€§ <code>malloc()</code>ç”¨ä»¥è°ƒç”¨ã€‚</li></ul></li><li>ä¸€ä¸ªè·Ÿè¸ªï¼ˆ<code>Marks&amp;Weep</code>ï¼‰åƒåœ¾å›æ”¶å™¨ã€‚<ul><li>å®ƒå®šæœŸç¡®å®šå¯ä»¥é€šè¿‡è·ŸéšæŒ‡é’ˆåˆ¤æ–­å“ªäº›å¯¹è±¡å¯è¾¾ã€‚</li><li>ä¹Ÿå¯ä»¥ç”¨äºå…¶ä»–ç›®çš„ã€‚</li></ul></li><li>ä¸€ä¸ªç®€å•çš„æ–¹æ³•å°†è¯¥åƒåœ¾å›æ”¶åŠ å…¥åˆ°è¿è¡Œæ—¶ç³»ç»Ÿ.<ul><li>æ˜“äºæ¥å£ã€‚</li><li>ä¸<code>C/C++</code>ä»£ç äº¤äº’è‰¯å¥½ã€‚</li><li><code>GCJï¼ˆJavaï¼‰</code>ã€<code>Monoï¼ˆC#, .NETï¼‰</code>ã€<code>Biglooï¼ˆSchemeï¼‰</code>ã€<code>MzScheme</code>ã€‚</li></ul></li><li>ç”¨äºè°ƒç”¨ <code>free()</code> çš„ç¨‹åºçš„æ³„æ¼æ£€æµ‹å™¨ã€‚<ul><li>ä¸å¯è¾¾çš„å¹¶ä¸”æœªé‡Šæ”¾å†…å­˜æ˜¯å†…å­˜æ³„æ¼ã€‚</li></ul></li></ul><p><code>GCJ</code> = <code>GNU Compiler for the Java Programing Language</code>(GNU Javaè¯­è¨€ç¼–è¯‘å™¨)</p><ul><li><code>Java</code>æºæ–‡ä»¶ -&gt; <code>Java</code>å­—èŠ‚ç æ–‡ä»¶</li><li><code>Java</code>æºæ–‡ä»¶ -&gt; <code>Java</code>æœ¬åœ°æœºå™¨ç </li><li><code>Java</code>å­—èŠ‚ç æ–‡ä»¶ -&gt; <code>Java</code>æœ¬åœ°æœºå™¨ç </li></ul><p><code>Bigloo</code>: <code>Biglooæ˜¯ä¸€ä¸ªé«˜æ•ˆçš„Schemeè¯­è¨€ç¼–ç¨‹ç¯å¢ƒ</code></p><p>é€šè¿‡å°† <code>Scheme</code> è½¬æˆ <code>C</code> è¯­è¨€æ¥ä¼˜åŒ–ç¼–è¯‘ï¼Œ<code>Bigloo</code> å…è®¸åœ¨ <code>Scheme</code> å’Œ <code>C</code> è¯­è¨€é—´è¿›è¡Œè¿æ¥ã€‚</p><p><code>MzScheme</code>: <code>MzSchemeæ˜¯ä¸€ä¸ªé«˜æ•ˆçš„Schemeè¯­è¨€ç¼–ç¨‹ç¯å¢ƒ</code>  </p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="example-lisp-s-expressions">Example: Lisp S-expressions<a class="hash-link" href="#example-lisp-s-expressions" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><div class="codeBlockContainer_CBWl language-c theme-code-block"><div class="codeBlockContent_vhl8" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-c codeBlock_w2AC thin-scrollbar"><code class="codeBlockLines_OfWd"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">include</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property string" style="color:#E3116C">&quot;gc.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">union</span><span class="token plain"> se </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">cons</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> cp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> sexpr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">cons</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">union</span><span class="token plain"> se head</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">union</span><span class="token plain"> se tail</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name function" style="color:#8250DF">car</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">s</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">s</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#005CC5">cp</span><span class="token macro property expression operator" style="color:#D73A49">-&gt;</span><span class="token macro property expression" style="color:#005CC5">head</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name function" style="color:#8250DF">cdr</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">s</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">s</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#005CC5">cp</span><span class="token macro property expression operator" style="color:#D73A49">-&gt;</span><span class="token macro property expression" style="color:#005CC5">tail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name function" style="color:#8250DF">from_i</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">z</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#005CC5">sexpr tmp</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#005CC5"> tmp</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#005CC5">i</span><span class="token macro property expression operator" style="color:#D73A49">=</span><span class="token macro property expression" style="color:#005CC5">z</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#005CC5"> tmp</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name function" style="color:#8250DF">to_i</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">s</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">s</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#005CC5">i</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sexpr </span><span class="token function" style="color:#8250DF">cons</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sexpr a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sexpr b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sexpr tmp </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#8250DF">GC_MALLOC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">cons</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#8250DF">car</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tmp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#8250DF">cdr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tmp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tmp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">to_i</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">car</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">cons</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">from_i</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">from_i</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="copyButton_R7VQ clean-btn"><span class="copyButtonIcons_Uqyx" aria-hidden="true"><svg class="copyButtonIcon_CtfL" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Mq1p" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="ç¤ºä¾‹lisp-s-expressions">ç¤ºä¾‹ï¼š<code>Lisp S-expressions</code><a class="hash-link" href="#ç¤ºä¾‹lisp-s-expressions" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>æ›¿æ¢ <code>malloc()</code> ä¸º <code>GC_MALLOC()</code>?</p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="where-did-it-come-from">Where did it come from?<a class="hash-link" href="#where-did-it-come-from" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Began life (ca. 1980) as a simple GC for the Russell programming language. (
Demers was original author.)</li><li>Later (ca. 1985?) changed to remove restrictions on generated code, and allow
use in the compiler itself.<ul><li>Eliminate endless debugging of manual reference counting.</li></ul></li><li>Used for student compilers for a language with higher-order functions.</li><li>Mark Weiser explored use as leak detector (ca. 1986).</li><li>A variant served as the Xerox Cedar GC from the late 80s, replacing
reference-count collector.</li><li>Unrelated to an earlier garbage collector for C written by Doug McIlroy and
apparently layered on top of malloc.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å®ƒæ˜¯ä»å“ªé‡Œæ¥çš„">å®ƒæ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ<a class="hash-link" href="#å®ƒæ˜¯ä»å“ªé‡Œæ¥çš„" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>ä½œä¸º <code>Russell</code> ç¼–ç¨‹è¯­è¨€çš„ç®€å• <code>GC</code> å¼€å§‹ç”Ÿæ´»ï¼ˆçº¦ 1980 å¹´ï¼‰ã€‚ï¼ˆå¾·é»˜æ–¯æ˜¯åŸä½œè€…ã€‚ï¼‰</li><li>åæ¥ï¼ˆå¤§çº¦ 1985 å¹´ï¼Ÿï¼‰æ›´æ”¹ä¸ºåˆ é™¤å¯¹ç”Ÿæˆä»£ç çš„é™åˆ¶ï¼Œå¹¶å…è®¸åœ¨ç¼–è¯‘å™¨æœ¬èº«ä¸­ä½¿ç”¨ã€‚<ul><li>æ¶ˆé™¤æ‰‹åŠ¨å¼•ç”¨è®¡æ•°çš„æ— ä¼‘æ­¢è°ƒè¯•ã€‚</li></ul></li><li>ç”¨äºå…·æœ‰é«˜é˜¶å‡½æ•°çš„è¯­è¨€çš„å­¦ç”Ÿç¼–è¯‘å™¨ã€‚</li><li><code>Mark Weiser</code> æ¢ç´¢äº†ç”¨ä½œæ£€æ¼ä»ªçš„ç”¨é€”ï¼ˆçº¦ 1986 å¹´ï¼‰ã€‚</li><li>80 å¹´ä»£åæœŸçš„ <code>Xerox Cedar GC</code> å˜ä½“å–ä»£äº†å¼•ç”¨è®¡æ•°æ”¶é›†å™¨ã€‚</li><li>ä¸ <code>Doug McIlroy</code> ä¸º <code>C</code> ç¼–å†™çš„æ—©æœŸåƒåœ¾æ”¶é›†å™¨æ— å…³ï¼Œå¹¶ä¸”æ˜¾ç„¶ä½äº <code>malloc</code> ä¹‹ä¸Šã€‚</li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="what-else-can-it-do">What else can it do?<a class="hash-link" href="#what-else-can-it-do" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>20 years of creeping features, including:<ul><li>Invoking finalizers after an object becomes unreachable.</li><li>Support for use in runtime systems.<ul><li>If the compiler wants to help, it can.</li></ul></li><li>Support for heap debugging.<ul><li>What&#x27;s in the heap?</li><li>Why is it still there? How can it still be referenced?</li></ul></li><li>Support for threads and multiprocessor GC.<ul><li>Maybe a way to speed up standard C applications on multiprocessors?</li></ul></li><li>Various mechanisms for reducing GC pauses:<ul><li>Incremental (but not hard real-time) GC.</li><li>Generational GC which concentrates effort on young objects.
(But objects are not moved.)</li><li>Abortable collections.</li></ul></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å®ƒè¿˜èƒ½åšä»€ä¹ˆ">å®ƒè¿˜èƒ½åšä»€ä¹ˆï¼Ÿ<a class="hash-link" href="#å®ƒè¿˜èƒ½åšä»€ä¹ˆ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>20å¹´æ¥çš„ç¼“æ…¢æ”¯æŒï¼ŒåŒ…æ‹¬ï¼š<ul><li>åœ¨å¯¹è±¡å˜å¾—ä¸å¯è¾¾åè°ƒç”¨ç»ˆç»“å™¨ã€‚</li><li>æ”¯æŒåœ¨è¿è¡Œæ—¶ç³»ç»Ÿä¸­ä½¿ç”¨ã€‚<ul><li>å¦‚æœç¼–è¯‘å™¨ä¹Ÿéœ€è¦å¸®åŠ©ï¼Œå®ƒå¯ä»¥åšåˆ°ã€‚</li></ul></li><li>æ”¯æŒ å † è°ƒè¯•ã€‚<ul><li>å † é‡Œæœ‰ä»€ä¹ˆï¼Ÿ</li><li>ä¸ºä»€ä¹ˆå®ƒè¿˜åœ¨é‚£é‡Œï¼Ÿå®ƒæ€ä¹ˆè¿˜èƒ½è¢«å¼•ç”¨ï¼Ÿ</li></ul></li><li>æ”¯æŒçº¿ç¨‹å’Œå¤šå¤„ç†å™¨<code>GC</code>ã€‚<ul><li>ä¹Ÿè®¸æ˜¯ä¸€ç§èƒ½åœ¨å¤šå¤„ç†å™¨ä¸ŠåŠ é€Ÿæ ‡å‡†<code>C</code>åº”ç”¨ç¨‹åºçš„æ–°æ–¹å¼ï¼Ÿ</li></ul></li><li>å‡å°‘<code>GC</code>æš‚åœçš„å„ç§æœºåˆ¶ï¼š<ul><li>å¢é‡ï¼ˆä½†ä¸æ˜¯ç¡¬å®æ—¶ï¼‰<code>GC</code>ã€‚</li><li>å°†ç²¾åŠ›é›†ä¸­åœ¨å¹´è½»å¯¹è±¡ä¸Šçš„åˆ†ä»£ <code>GC</code>.(ä½†æ˜¯å¯¹è±¡å¹¶ä¸ä¼šç§»åŠ¨.)</li><li>å¯ä¸­æ­¢å›æ”¶è¿‡ç¨‹ã€‚</li></ul></li></ul></li></ul><p>è¿™é‡Œè¯´æ˜äº†, è¯¥ç®—æ³•å¹¶ä¸æ‰“ç®—æŠŠå¯¹è±¡æ‹·è´æ¥æ‹·è´å»çš„.</p><p>å¯¹äºæœºèº«æ€§èƒ½è¿˜æ²¡æº¢å‡ºçš„äº§å“ä¸Š, ä½¿ç”¨è¯¥<code>GC</code>ç®—æ³•, å¯ä»¥è¯´æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ–¹æ¡ˆäº†.</p><p>æ¯”å¦‚æ‰‹æœº.</p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="what-cant-it-do">What can&#x27;t it do?<a class="hash-link" href="#what-cant-it-do" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Reclaim memory or invoke finalizers/destructors immediately.<ul><li>Like all tracing garbage collectors, it only checks for unreachable memory occasionally. </li><li>And synchronous heap finalizers are broken anyway...</li></ul></li><li>Reclaim all unreachable objects.<ul><li>Generally a few will still have pointers to them stored somewhere.</li><li>The GC doesn&#x27;t know which registers will be referenced. </li><li>And there are other issues ...</li><li>And unreachable isn&#x27;t well-defined anyway ...</li><li>But we generally avoid growing leaks.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å®ƒä¸èƒ½åšä»€ä¹ˆ">å®ƒä¸èƒ½åšä»€ä¹ˆ?<a class="hash-link" href="#å®ƒä¸èƒ½åšä»€ä¹ˆ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>ç«‹å³å›æ”¶å†…å­˜æˆ–è°ƒç”¨ç»ˆç»“å™¨/ææ„å‡½æ•°ã€‚<ul><li>ä¸æ‰€æœ‰è·Ÿè¸ªåƒåœ¾æ”¶é›†å™¨ä¸€æ ·ï¼Œå®ƒåªæ˜¯å¶å°”æ£€æŸ¥ä¸å¯è¾¾å†…å­˜.</li><li>æ— è®ºå¦‚ä½•, åŒæ­¥å †ç»ˆç»“å™¨éƒ½è¢«ç ´åäº†...</li></ul></li><li>å›æ”¶æ‰€æœ‰æ‰€æœ‰ä¸å¯è¾¾å¯¹è±¡ã€‚<ul><li>ä¸€èˆ¬æ¥è¯´ï¼Œä¸€äº›äººä»ç„¶ä¼šåœ¨æŸå¤„å­˜å‚¨æŒ‡å‘å®ƒä»¬çš„æŒ‡é’ˆã€‚</li><li><code>GC</code>ä¸çŸ¥é“å°†å¼•ç”¨å“ªäº›å¯„å­˜å™¨ã€‚</li><li>è¿˜æœ‰å…¶ä»–é—®é¢˜...</li><li>ä¸å¯è¾¾å…¶å®ä¹Ÿæ˜¯ä¸å¾ˆæ˜ç¡®çš„å®šä¹‰...</li><li>ä½†æˆ‘ä»¬é€šå¸¸ä¼šé¿å…è¶Šæ¥è¶Šå¤šçš„æ³„æ¼ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="dealing-with-c-conservative-garbage-collection">Dealing with C: Conservative Garbage Collection<a class="hash-link" href="#dealing-with-c-conservative-garbage-collection" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>For C/C++ programs, we may not know where the pointer variables (roots) are.<ul><li>We may want to use a standard compiler. (Slightly risky with optimization, but popular.)</li><li>Program may use C unions.</li></ul></li><li>Even layout of heap objects may be unknown.</li><li>It&#x27;s easier to build a Java/Scheme/ML/... compiler if pointer location information is optional.</li><li><strong>Conservative collectors handle pointer location uncertainty:</strong><ul><li><strong><em>If it might be a pointer it&#x27;s treated as a pointer.</em></strong></li><li><strong>Objects with ambiguous references are not moved.</strong><ul><li><strong>And we never move any objects.</strong></li></ul></li><li><strong>May lead to accidental retention of garbage objects.</strong></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="ä¸cæ‰“äº¤é“ä¿å®ˆçš„åƒåœ¾æ”¶é›†">ä¸<code>C</code>æ‰“äº¤é“ï¼šä¿å®ˆçš„åƒåœ¾æ”¶é›†<a class="hash-link" href="#ä¸cæ‰“äº¤é“ä¿å®ˆçš„åƒåœ¾æ”¶é›†" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>å¯¹äº<code>C/C++</code>ç¨‹åºï¼Œæˆ‘ä»¬å¯èƒ½ä¸çŸ¥é“æŒ‡é’ˆå˜é‡ï¼ˆ<code>root set</code>ï¼‰åœ¨å“ªé‡Œã€‚<ul><li>æˆ‘ä»¬å¯èƒ½éœ€è¦ä½¿ç”¨æ ‡å‡†ç¼–è¯‘å™¨ã€‚ï¼ˆä¼˜åŒ–æœ‰ç‚¹é£é™©ï¼Œä½†æ˜¯å¾ˆå—æ¬¢è¿ã€‚ï¼‰</li><li>ç¨‹åºå¯ä»¥ä½¿ç”¨<code>C</code>çš„<code>union</code>(è”åˆ)ã€‚</li></ul></li><li>ç”šè‡³å †å¯¹è±¡çš„å¸ƒå±€ä¹Ÿå¯èƒ½æ˜¯æœªçŸ¥çš„ã€‚</li><li>å¦‚æœæŒ‡é’ˆä½ç½®ä¿¡æ¯æ˜¯å¯é€‰çš„ã€‚é‚£ä¹ˆæ„å»º<code>Java/Scheme/ML...</code>ç¼–è¯‘å™¨å°±ä¼šæ›´å®¹æ˜“.</li><li><strong>ä¿å®ˆæ”¶é›†å™¨å¤„ç†æŒ‡é’ˆä½ç½®ä¸ç¡®å®šæ€§ï¼š</strong><ul><li><strong><em>å¦‚æœå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œåˆ™å°†å…¶è§†ä¸ºæŒ‡é’ˆã€‚</em></strong></li><li><strong>ä¸ç§»åŠ¨å…·æœ‰ä¸æ˜ç¡®å¼•ç”¨çš„å¯¹è±¡ã€‚</strong><ul><li><strong>æ¯•ç«Ÿ, æˆ‘ä»¬ä»ä¸ç§»åŠ¨ä»»ä½•ç‰©ä½“ã€‚</strong></li></ul></li><li><strong>å¯èƒ½ä¼šå¯¼è‡´åƒåœ¾å¯¹è±¡çš„æ„å¤–ä¿ç•™ã€‚</strong></li></ul></li></ul><blockquote><p>å¼•ç”¨ <a href="https://www.bilibili.com/video/BV1r44y1z7X3?p=2&amp;t=38m56s" target="_blank" rel="noopener noreferrer">é«˜å·è€å¸ˆ</a> æ¼”è®²æ—¶å€™çš„è¯, </p></blockquote><p>åœ¨ä¿å®ˆå†…å­˜å›æ”¶å™¨æ¥çœ‹ï¼Œå½“å›æ”¶ä¸€ä¸ªå†…å­˜å—çš„æ—¶å€™ï¼Œä¼šå°è¯•æ‰¾åˆ°å†…å­˜å—ä¸‹è¾¹æ‰€æœ‰çš„æŒ‡é’ˆæŒ‡å‘çš„åœ°å€ï¼Œå¹¶ä¸”æ ‡è®°ä¸ºå¼•ç”¨ã€‚æ¯”å¦‚è¯´ <code>Object a</code> å¼•ç”¨äº† <code>Object b</code> ï¼Œå½“ <code>Object a</code> ä¸èƒ½å›æ”¶çš„æ—¶å€™ï¼Œä¼šåŒæ—¶æ ‡è®° <code>Object b</code> ä¹Ÿä¸èƒ½è¢«å›æ”¶ã€‚</p><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220410092737.png" class="img_PFMr"></p><ul><li>å¦‚ä½•çŸ¥é“è¿™ä¸ªä¸œè¥¿æ˜¯ä¸€ä¸ªæ•°è¿˜æ˜¯ä¸€ä¸ªæŒ‡é’ˆçš„ï¼Ÿ</li><li>é çŒœ!</li></ul><p>è¿™æœ‰ä¸€ä¸ª <code>potential pointer</code>æ½œåœ¨æŒ‡é’ˆï¼Œå¹¶ä¸çŸ¥é“å®ƒæ˜¯ä¸æ˜¯çœŸçš„æŒ‡é’ˆï¼Œè€Œä»¥ä¸€ä¸ª <code>pattern</code> çš„æ–¹å¼æ¥æ£€æŸ¥å½“å‰è¿™ä¸ªæ•°æœ‰æ²¡æœ‰å¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚</p><p>æ¯”å¦‚è¯´ç¬¬ä¸€ä¸ªæŒ‡é’ˆï¼Œæ£€æŸ¥<code>0x011</code>è¿™ä¸ªæ•°å€¼æ‰€æŒ‡å‘çš„åœ°å€é‡Œè¾¹æœ‰æ²¡æœ‰ä¸œè¥¿ï¼Œè‹¥æœ‰å°±æ ‡è®°æˆ 1 ï¼Œè¿™æ¬¡ä¸å›æ”¶ã€‚<code>0x012</code> æŒ‡å‘äº† <code>Object c</code>ï¼Œ <code>Object c</code> å’Œ <code>Object a</code> æ²¡æœ‰åº”ç”¨ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯å®ƒæ°å¥½åˆ†é…åˆ°äº†è¿™å—å†…å­˜ä¸Šã€‚</p><p>å¯¹äºè´æ¯æ¥è¯´ï¼ŒæŒ‡çš„è¿™å—åœ°æ–¹ï¼Œæœ‰ä¸œè¥¿ä¸å›æ”¶ã€‚<code>0x013</code> æŒ‡å‘äº†ä¸€å—æ²¡ç”¨çš„å†…å­˜ã€‚</p><p>è´æ¯åƒåœ¾å›æ”¶ä¼šæŠŠè¿™ä¸ªåœ°å€åŠ åˆ°é»‘åå•é‡Œã€‚å½“ä¸‹æ¬¡è¿›è¡Œå¤§å†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œåˆšå¥½è¸©åˆ°äº†è¿™ä¸ªåœ°å€çš„æ—¶å€™ï¼Œè´æ¯ä¼šå‘Šè¯‰ä½ è¿™å—å†…å­˜ä¸èƒ½ç”¨ï¼Œè´æ¯æŠŠå®ƒå…ˆç•™ä¸‹äº†ï¼Œä½ å†å»åˆ†é…ä¸€å—ã€‚</p><p>è¿™å°±æ˜¯éç²¾å‡†ï¼Œå¯¹äºè¦å›æ”¶çš„å†…å­˜ï¼Œå®ƒå¯èƒ½æ”¶ä¸å›æ¥ï¼Œå¯¹äºæ²¡ç”¨çš„å†…å­˜ï¼Œå®ƒä¹Ÿå¯èƒ½ä¸è®©ç”¨ã€‚</p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="c-interface-overview">C Interface overview<a class="hash-link" href="#c-interface-overview" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p>Debugging support: GC_xyz() vs. GC_XYZ() functions:</p><ul><li>GC_xyz() is the real function.</li><li>GC_XYZ(x) expands to either <code>GC_xyx(x)</code> or <code>GC_debug_xyz(x, &lt;source position, etc&gt;)</code>.</li><li>Clients should:<ul><li>Use the all-caps version.</li><li>Always include gc.h.</li><li>Define GC_DEBUG before including gc.h for debugging.</li></ul></li><li>This is becoming obsolete technology.<ul><li>Requires too much recompilation.</li><li>Libunwind, addr2line allow better alternatives.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="cæ¥å£æ¦‚è¿°"><code>C</code>æ¥å£æ¦‚è¿°<a class="hash-link" href="#cæ¥å£æ¦‚è¿°" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>è°ƒè¯•æ”¯æŒï¼š<code>GC_xyz()</code> vs. <code>GC_XYZ()</code>:</p><ul><li><code>GC_xyz()</code> æ˜¯çœŸæ­£çš„å‡½æ•°.</li><li><code>GC_XYZ(x)</code> å±•å¼€ä¸º <code>GC_xyx(x)</code> or <code>GC_debug_xyz(x, &lt;source position, etc&gt;)</code></li><li>å®¢æˆ·ç«¯åº”è¯¥:<ul><li>ä½¿ç”¨å…¨å¤§å†™ç‰ˆæœ¬ã€‚</li><li>å§‹ç»ˆåŒ…æ‹¬ <code>gc.h</code></li><li>åœ¨åŒ…å«<code>gc.h</code>è¿›è¡Œè°ƒè¯•ä¹‹å‰å®šä¹‰<code>GC_DEBUG</code>ã€‚</li></ul></li><li>è¿™æ­£åœ¨æˆä¸ºè¿‡æ—¶çš„æŠ€æœ¯ã€‚<ul><li>éœ€è¦å¤ªå¤šçš„é‡æ–°ç¼–è¯‘ã€‚</li><li><code>Libunwind</code>ã€<code>addr2line</code> å…è®¸æ›´å¥½çš„é€‰æ‹©ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="c-interface-main-functions">C interface, main functions<a class="hash-link" href="#c-interface-main-functions" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>GC_MALLOC(bytes)<ul><li>In simple cases, this is enough.</li></ul></li><li>GC_MALLOC_ATOMIC(bytes)<ul><li>Allocate pointer-free or untraced (but collected) memory.</li></ul></li><li>GC_MALLOC_UNCOLLECTABLE(bytes)<ul><li>Allocate uncollectable (but traced) memory.</li></ul></li><li>GC_REALLOC(p, bytes)</li><li>GC_REGISTER_FINALIZER(...)<ul><li>Register (or unregister or retrieve) &quot;finalizer&quot; code to be called when an
object is otherwise &quot;unreachable&quot;. </li><li>Unlike Java, by default, an object is reachable if it can be referenced from other finalizers. (Also Java variant.)</li></ul></li><li>GC_INIT()  Optional on most platforms. (Must be called from main program on a
few.)</li><li>GC_FREE()  If you insist. (Usually helps performance for large objects, hurts
for small ones.)</li><li>GC_MALLOC_IGNORE_OFF_PAGE()  Like GC_MALLOC(), but for large arrays with
pointers to (near) the beginning.</li><li>Plus statistics, control of incremental GC, more allocator variants, heap
limits, GC frequency controls, fast inline allocators, etc.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="c-æ¥å£-ä¸»è¦çš„ä¸€äº›æ–¹æ³•"><code>C</code> æ¥å£, ä¸»è¦çš„ä¸€äº›æ–¹æ³•:<a class="hash-link" href="#c-æ¥å£-ä¸»è¦çš„ä¸€äº›æ–¹æ³•" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li><code>GC_MALLOC(bytes)</code><ul><li>åœ¨ç®€å•çš„æƒ…å†µä¸‹ï¼Œè¿™å°±è¶³å¤Ÿäº†ã€‚</li></ul></li><li><code>GC_MALLOC_ATOMIC(bytes)</code><ul><li>åˆ†é…æ— æŒ‡é’ˆæˆ–æœªè·Ÿè¸ªï¼ˆä½†å·²å›æ”¶è¿‡ï¼‰å†…å­˜ã€‚</li></ul></li><li><code>GC_MALLOC_UNCOLLECTABLE(bytes)</code><ul><li>åˆ†é…æ— æ³•å›æ”¶çš„ï¼ˆä½†å·²è·Ÿè¸ªï¼‰çš„å†…å­˜ã€‚</li></ul></li><li><code>GC_REALLOC(p, bytes)</code></li><li><code>GC_REGISTER_FINALIZER(...)</code><ul><li>æ³¨å†Œï¼ˆæˆ–æ³¨é”€æˆ–æ£€ç´¢ï¼‰&quot;ç»ˆç»“å™¨&quot;ä»£ç ä»¥åœ¨å¯¹è±¡&quot;ä¸å¯è¾¾&quot;æ—¶è°ƒç”¨ã€‚</li><li>ä¸ <code>Java</code> ä¸åŒï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœå¯ä»¥ä»å…¶ä»–ç»ˆç»“å™¨å¼•ç”¨å¯¹è±¡ï¼Œåˆ™è¯¥å¯¹è±¡æ˜¯å¯è®¿é—®çš„ã€‚ï¼ˆ <code>Java</code> å˜ä½“ä¹Ÿæ˜¯ã€‚ï¼‰</li></ul></li><li><code>GC_INIT() </code><ul><li>åœ¨å¤§å¤šæ•°å¹³å°ä¸Šéƒ½æ˜¯å¯é€‰çš„ã€‚ (å¿…é¡»åœ¨å°‘æ•°æƒ…å†µä¸‹ä»ä¸»ç¨‹åºè°ƒç”¨ã€‚)</li></ul></li><li><code>GC_FREE()</code>  <ul><li>å¦‚æœä½ åšæŒ. (é€šå¸¸å¯¹å¤§å¯¹è±¡æœ‰å¸®åŠ©ï¼Œå¯¹å°å¯¹è±¡æœ‰ä¼¤å®³.)</li></ul></li><li><code>GC_MALLOC_IGNORE_OFF_PAGE()</code> <ul><li>ä¸<code>GC_MALLOC()</code>ç±»ä¼¼, ä½†ç”¨äºæŒ‡é’ˆæŒ‡å‘ï¼ˆæ¥è¿‘ï¼‰å¼€å¤´çš„å¤§å‹æ•°ç»„ã€‚</li></ul></li><li>åŠ ä¸Šç»Ÿè®¡æ•°æ®ã€å¢é‡<code>GC</code>æ§åˆ¶ã€æ›´å¤šåˆ†é…å™¨å˜é‡ã€å †é™åˆ¶ã€<code>GC</code>é¢‘ç‡æ§åˆ¶ã€å¿«é€Ÿå†…è”åˆ†é…å™¨ç­‰ã€‚</li></ul><hr><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="c-interface">C++ interface<a class="hash-link" href="#c-interface" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>&quot;gc_cpp.h&quot; provides a base class gc:<ul><li>Overrides new to be GC_MALLOC for subclasses of gc. </li><li>Overrides ::new to be GC_MALLOC_UNCOLLECTABLE. </li><li>Provide gc_cleanup class which registers destructor as finalizer. </li><li>Built by Detlefs, Hull, based on Ellis, Detlefs work. </li><li>...</li></ul></li><li>&quot;gc_allocator.h&quot; defines STL allocators:<ul><li>gc_allocator </li><li>traceable_allocator</li></ul></li><li>Particularly gc_cpp.h is annoyingly brittle.<ul><li>Perhaps more so than some of the gross hacks we&#x27;ll hint at later.</li><li>Replacing global operator new seems problematic for many compilers.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="cæ¥å£"><code>C++</code>æ¥å£<a class="hash-link" href="#cæ¥å£" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>&quot;<code>gc_cpp.h</code>&quot;æä¾›äº†ä¸€ä¸ªåŸºç±»<code>gc</code>ï¼š<ul><li>ä¸º <code>gc</code> çš„å­ç±»è¦†ç›– <code>new</code> ä¸º <code>GC_MALLOC</code>ã€‚</li><li>å°† <code>::new</code> è¦†ç›–ä¸º <code>GC_MALLOC_UNCOLLECTABLE</code>ã€‚</li><li>æä¾›å°†ææ„å‡½æ•°æ³¨å†Œä¸ºç»ˆç»“å™¨çš„ <code>gc_cleanup</code> ç±»ã€‚</li><li><code>Detlefs</code> ç”±èµ«å°”çš„ <code>Detlefs</code> å»ºé€ ï¼ŒåŸºäº <code>Ellis</code>ï¼Œ<code>Detlefs</code> å·¥ä½œã€‚</li><li>...</li></ul></li><li>&quot;<code>gc_allocator.h</code>&quot;å®šä¹‰<code>STL</code>åˆ†é…å™¨ï¼š<ul><li><code>gc_allocator</code></li><li><code>traceable_allocator</code>(å¯è¿½è¸ªåˆ†é…å™¨)</li></ul></li><li>å°¤å…¶æ˜¯<code>gc_cpp.h</code>éå¸¸è„†å¼±ã€‚<ul><li>ä¹Ÿè®¸æ¯”æˆ‘ä»¬ç¨åä¼šæš—ç¤ºçš„ä¸€äº›ä¸¥é‡çš„é»‘å®¢æ”»å‡»æ›´é‡è¦ã€‚</li><li>å¯¹è®¸å¤šç¼–è¯‘å™¨æ¥è¯´ï¼Œæ›¿æ¢å…¨å±€è¿ç®—ç¬¦<code>new</code>ä¼¼ä¹æœ‰é—®é¢˜ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="environment-variables">Environment variables<a class="hash-link" href="#environment-variables" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Collector can be influenced by various environment variables:<ul><li>GC_INITIAL_HEAP_SIZE</li><li>GC_MAXIMUM_HEAP_SIZE</li><li>GC_PRINT_STATS</li><li>GC_DUMP_REGULARLY</li><li>GC_ENABLE_INCREMENTAL (caution!)</li><li>GC_PAUSE_TIME_TARGET</li><li>GC_DON&#x27;T_GC</li><li>GC_IGNORE_GCJ_INFO ignore compiler-provided pointer location information.</li><li>GC_MARKERS Set the number of GC threads (where supported).</li><li>...</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="ç¯å¢ƒå˜é‡">ç¯å¢ƒå˜é‡<a class="hash-link" href="#ç¯å¢ƒå˜é‡" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>å›æ”¶å™¨å¯èƒ½ä¼šå—åˆ°å„ç§ç¯å¢ƒå˜é‡çš„å½±å“:<ul><li><code>GC_INITIAL_HEAP_SIZE</code></li><li><code>GC_MAXIMUM_HEAP_SIZE</code></li><li><code>GC_PRINT_STATS</code></li><li><code>GC_DUMP_REGULARLY</code></li><li><code>GC_ENABLE_INCREMENTAL</code> (å°å¿ƒä½¿ç”¨!)</li><li><code>GC_PAUSE_TIME_TARGET</code></li><li><code>GC_DON&#x27;T_GC</code></li><li><code>GC_IGNORE_GCJ_INFO</code> <ul><li>å¿½ç•¥ç¼–è¯‘å™¨æä¾›çš„æŒ‡é’ˆä½ç½®ä¿¡æ¯ã€‚</li></ul></li><li><code>GC_MARKERS</code> <ul><li>è®¾ç½®<code>GC</code>çº¿ç¨‹çš„æ•°é‡ï¼ˆå¦‚æœæ”¯æŒï¼‰ã€‚</li></ul></li><li>...</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="how-does-it-work">How does it work?<a class="hash-link" href="#how-does-it-work" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p>Occasionally (when we run out of memory?):</p><ul><li>Mark all objects referenced directly by pointer variables (roots)</li><li>Repeatedly:<ul><li>Mark objects directly reachable from newly marked objects.</li></ul></li><li>Finally identify unmarked objects (sweep)<ul><li>E.g. put them in free lists.</li><li>Reuse to satisfy allocation requests.</li></ul></li><li><strong>Objects are not moved.</strong></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„">å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ<a class="hash-link" href="#å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>å¶å°”ï¼ˆå½“æˆ‘ä»¬ç”¨å®Œå†…å­˜æ—¶ï¼Ÿï¼‰ï¼š</p><ul><li>æ ‡è®°æŒ‡é’ˆå˜é‡(<code>roots set</code>)èƒ½ç›´æ¥å¼•ç”¨åˆ°çš„æ‰€æœ‰å¯¹è±¡</li><li>é‡å¤åœ°ï¼š<ul><li>æ ‡è®°å¯ä»æ–°æ ‡è®°çš„å¯¹è±¡ç›´æ¥å¯è¾¾çš„å¯¹è±¡ã€‚</li></ul></li><li>æœ€åè¯†åˆ«æœªæ ‡è®°çš„å¯¹è±¡ï¼ˆæ¸…é™¤ï¼‰<ul><li>ä¾‹å¦‚: æŠŠä»–ä»¬æ”¾åœ¨<code>free list</code>ä¸Šã€‚</li><li>é‡ç”¨ä»¥æ»¡è¶³åˆ†é…å†…å­˜è¯·æ±‚ã€‚</li></ul></li><li><strong>å¯¹è±¡ä¸ä¼šç§»åŠ¨ã€‚</strong></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="marksweep-illustration">Mark/sweep illustration<a class="hash-link" href="#marksweep-illustration" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li><p>ç¬¬ä¸€æ­¥(æ ‡è®°):
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409213248.png" class="img_PFMr"></p></li><li><p>ç¬¬äºŒéƒ¨(æ¸…é™¤)
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409213447.png" class="img_PFMr"></p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="æ ‡è®°æ¸…é™¤-æ’ç”»">æ ‡è®°/æ¸…é™¤ æ’ç”»<a class="hash-link" href="#æ ‡è®°æ¸…é™¤-æ’ç”»" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>ä»<code>Stack</code>(æ ¹)å‡ºå‘, ä¾æ¬¡æ ‡è®°(ç»¿è‰²å¯¹å‹¾)æ ‡è®°å¯è¾¾çš„ å † çš„å†…å­˜ç©ºé—´. ç„¶å&quot;æ¸…é™¤&quot;æœªè¢«æ ‡è®°çš„.</p><p>ä»å›¾ç¤ºæ¥ç†è§£:
è¿™é‡Œè¿™ä¸ªæ¸…é™¤å…¶å®è›®ç®€å•çš„, åªæ˜¯å•çº¯æ”¾åˆ°ä¸€ä¸ª <code>free list</code> é‡Œé¢, ç­‰è¦æœ‰éœ€è¦çš„æ—¶å€™è¢«é‡æ–°åˆ†é….</p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="easy-performance-issue">Easy performance issue<a class="hash-link" href="#easy-performance-issue" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ol><li></li></ol><ul><li>If heap is nearly full, we collect too frequently.<ul><li>May collect once per allocation. </li><li>We look at all reachable objects each time -&gt; expensive</li></ul></li><li>Solution:<ul><li>Always make sure that heap is e.g. 1.5 times larger than necessary.</li><li>Each cycle, allocate n/3 bytes, trace 2n/3 bytes.</li><li>Trace 2 bytes per byte allocated.
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/live-data.png" class="img_PFMr"></li></ul></li></ul><ol start="2"><li></li></ol><ul><li>Performance is often dominated by memory accesses.</li><li>Each reclaimed object is touched twice per cycle.<ul><li>Once during sweep phase.</li><li>Once during allocation.</li></ul></li><li>Solution:<ul><li>Sweep a little bit at a time before allocation.</li><li>Try to keep object in cache.</li><li>&quot;Sweep phase&quot; is a misnomer.</li><li>Imposes constraints on GC data structure.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="ç®€å•æ€§èƒ½é—®é¢˜">ç®€å•æ€§èƒ½é—®é¢˜<a class="hash-link" href="#ç®€å•æ€§èƒ½é—®é¢˜" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ol><li></li></ol><ul><li>å¦‚æœå †å¿«æ»¡äº†ï¼Œæˆ‘ä»¬å°±å›æ”¶åœ°æ›´é¢‘ç¹ã€‚<ul><li>æ¯æ¬¡åˆ†é…å¯å›æ”¶ä¸€æ¬¡ã€‚</li><li>æˆ‘ä»¬æ¯æ¬¡éƒ½ä¼šæŸ¥çœ‹æ‰€æœ‰å¯è¾¾çš„å¯¹è±¡ -&gt; æ˜‚è´µ</li></ul></li><li>è§£å†³æ–¹æ¡ˆï¼š<ul><li>å§‹ç»ˆç¡®ä¿ å † æ¯”éœ€è¦çš„å¤§1.5å€ã€‚</li><li>æ¯ä¸ªå‘¨æœŸï¼Œåˆ†é… <code>n/3</code> å­—èŠ‚æ—¶ï¼Œè·Ÿè¸ª <code>2n/3</code> å­—èŠ‚ã€‚</li><li>åœ¨åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´é‡Œè·Ÿè¸ªå‰2ä¸ªå­—èŠ‚ã€‚
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/live-data.png" class="img_PFMr"></li></ul></li></ul><ol start="2"><li></li></ol><ul><li>æ€§èƒ½é€šå¸¸ç”±å†…å­˜è®¿é—®å†³å®šã€‚</li><li>æ¯ä¸ªå›æ”¶çš„å¯¹è±¡æ¯ä¸ªå‘¨æœŸè¢«è§¦æ‘¸ä¸¤æ¬¡ã€‚<ul><li>ä¸€æ¬¡åœ¨æ¸…é™¤é˜¶æ®µã€‚</li><li>ä¸€æ¬¡åœ¨åˆ†é…è¿‡ç¨‹ä¸­ã€‚</li></ul></li><li>è§£å†³æ–¹æ¡ˆï¼š<ul><li>åˆ†é…å‰ä¸€æ¬¡æ¸…é™¤ä¸€ç‚¹ã€‚</li><li>å°è¯•å°†å¯¹è±¡ä¿ç•™åœ¨ç¼“å­˜ä¸­ã€‚</li><li>&quot;æ¸…é™¤é˜¶æ®µ&quot;ç”¨è¯ä¸å½“ã€‚</li><li>å¯¹<code>GC</code>æ•°æ®ç»“æ„æ–½åŠ çº¦æŸã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="asymptotic-complexity-of-marksweep-vs-copying">Asymptotic Complexity of MarkSweep vs. Copying<a class="hash-link" href="#asymptotic-complexity-of-marksweep-vs-copying" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Conventional view:<ul><li>Copying: O(live_data_size)</li><li>M/S:<ul><li>Mark: O(live_data_size)</li><li>Sweep: O(heap_size)</li><li>Total: O(heap_size)</li></ul></li><li>M/S more expensive (if heap_size &gt;&gt; live_data_size)</li></ul></li><li>Alternate view:<ul><li>Sweep doesn&#x27;t count; part of allocation.</li><li>M/S can avoid touching pointer-free data (strings, bitmaps)</li><li>M/S: O(pointer_containing_data)</li><li>Copying more expensive<ul><li>(if pointer_containing_data &lt;&lt; live_data_size)</li></ul></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="è¿è¡Œæ—¶é—´å¤æ‚åº¦-ms-vs-copyingåˆ†æ">è¿è¡Œæ—¶é—´å¤æ‚åº¦ <code>M&amp;S</code> vs <code>Copying</code>åˆ†æ.<a class="hash-link" href="#è¿è¡Œæ—¶é—´å¤æ‚åº¦-ms-vs-copyingåˆ†æ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>ä¼ ç»Ÿè§‚ç‚¹ï¼š<ul><li><code>Copying</code> ï¼š<code>O(live_data_size)</code></li><li><code>M&amp;S</code>:<ul><li>æ ‡è®°: <code>O(live_data_size)</code></li><li>æ‰«æ: <code>O(heap_size)</code></li><li>æ€»è®¡: <code>O(heap_size)</code></li></ul></li><li><code>M&amp;S</code> å¤æ‚åº¦æ›´é«˜å½“ï¼ˆ<code>heap_size</code> &gt;&gt; <code>live_data_size)</code></li></ul></li><li>å¦ä¸€ç§è§‚ç‚¹ï¼š<ul><li>æ¸…é™¤ä¸ç®—æ•°åˆ†é…çš„ä¸€éƒ¨åˆ†ã€‚</li><li><code>M&amp;S</code>å¯ä»¥é¿å…æ¥è§¦æ— æŒ‡é’ˆæ•°æ®ï¼ˆå­—ç¬¦ä¸²ã€ä½å›¾ï¼‰</li><li><code>M&amp;S</code>: <code>O(pointer_containing_data)</code></li><li><code>Copying</code> å¤æ‚åº¦æ›´é«˜å½“<ul><li>ï¼ˆå¦‚æœ <code>pointer_containing_data</code> &lt;&lt; <code>live_data_size</code> ï¼‰</li></ul></li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="implementation-details-overview">Implementation details overview<a class="hash-link" href="#implementation-details-overview" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>General design issues:<ul><li>The underlying allocator.</li><li><strong>Pointer validity checks and mark bits.</strong></li><li>Partial pointer location information.</li><li><strong>Locating potential roots.</strong></li><li>Mark algorithm and stack overflow.</li><li>Thread support.</li></ul></li><li>Enhancements:<ul><li><strong>Black-listing of &quot;false pointers&quot;</strong></li><li>Incremental/Concurrent/Generational GC.</li><li>Parallel marking.</li><li>Thread-local allocation.</li><li>Finalization.</li><li>Debug support.</li></ul></li></ul><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200001.png" class="img_PFMr"></p><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å®ç°ç»†èŠ‚æè¿°">å®ç°ç»†èŠ‚æè¿°<a class="hash-link" href="#å®ç°ç»†èŠ‚æè¿°" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>ä¸€èˆ¬è®¾è®¡é—®é¢˜ï¼š<ul><li>åº•å±‚åˆ†é…å™¨ã€‚</li><li><strong>æŒ‡é’ˆæœ‰æ•ˆæ€§æ£€æŸ¥å¹¶æ ‡è®°ä½ã€‚</strong></li><li>éƒ¨åˆ†æŒ‡é’ˆä½ç½®ä¿¡æ¯ã€‚</li><li><strong>å¯»æ‰¾æ½œåœ¨çš„æ ¹<code>roots set</code>ã€‚</strong></li><li>æ ‡è®°ç®—æ³•å’Œå †æ ˆæº¢å‡ºã€‚</li><li>çº¿ç¨‹æ”¯æŒã€‚</li></ul></li><li>å¢å¼ºåŠŸèƒ½ï¼š<ul><li><strong>&quot;é”™è¯¯æŒ‡é’ˆ&quot;é»‘åå•</strong></li><li>å¢é‡/å¹¶å‘/åˆ†ä»£<code>GC</code>ã€‚</li><li>å¹³è¡Œæ ‡è®°ã€‚</li><li>çº¿ç¨‹æœ¬åœ°åˆ†é…ã€‚</li><li>ç»ˆç»“ã€‚</li><li>è°ƒè¯•æ”¯æŒã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="allocator-design">Allocator design<a class="hash-link" href="#allocator-design" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Segregate objects by size, pointer contents...</li><li>Each &quot;page&quot; contains objects of a single size.</li><li>Separate free lists for each small object size.</li><li>Large object allocator for pages, large objects.</li><li><strong>Characteristics:</strong><ul><li><strong>No per object space overhead (except mark bits)</strong></li><li><strong>Small object fragmentation overhead factor:</strong><ul><li><strong>&lt; #size classes = O(log(largest_sz/smallest_sz))</strong></li><li><strong>Asymptotically optimal (Robson 71)</strong></li></ul></li><li><strong>Fast allocation.</strong></li><li><strong>Partial sweeps are possible.</strong></li><li><strong>Can avoid touching pointer-free pages.</strong></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="åˆ†é…å™¨è®¾è®¡">åˆ†é…å™¨è®¾è®¡<a class="hash-link" href="#åˆ†é…å™¨è®¾è®¡" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>æŒ‰å¤§å°ã€æŒ‡é’ˆå†…å®¹åˆ†éš”å¯¹è±¡...</li><li>æ¯ä¸ª<code>&quot;page&quot;</code>åŒ…å«å•ä¸ªå¤§å°çš„å¯¹è±¡ã€‚</li><li>æ¯ä¸ªå°å¯¹è±¡å¤§å°éƒ½æœ‰å•ç‹¬åœ°<code>free list</code>ã€‚</li><li>ç”¨äº<code>page</code>ã€å¤§å¯¹è±¡çš„å¤§å¯¹è±¡åˆ†é…å™¨ã€‚</li><li><strong>ç‰¹ç‚¹</strong>ï¼š<ul><li><strong>æ— æ¯å¯¹è±¡ç©ºé—´å¼€é”€ï¼ˆæ ‡è®°ä½é™¤å¤–ï¼‰</strong></li><li><strong>å°å¯¹è±¡ç¢ç‰‡å¼€é”€ç³»æ•°ï¼š</strong><ul><li><strong><code>O(log(largest_sz/smallest_sz))</code></strong></li><li><strong>æ¸è¿‘æœ€ä¼˜ï¼ˆ<code>Robson 71</code>ï¼‰</strong></li></ul></li><li><strong>å¿«é€Ÿåˆ†é…</strong>ã€‚</li><li><strong>éƒ¨åˆ†æ‰«ææ˜¯å¯èƒ½çš„ã€‚</strong></li><li><strong>å¯ä»¥é¿å…è§¦æ‘¸æ— æŒ‡é’ˆ<code>page</code>ã€‚</strong></li></ul></li></ul><p><a href="https://www.bilibili.com/video/BV1r44y1z7X3?p=2&amp;t=35m05s" target="_blank" rel="noopener noreferrer">é«˜å·è€å¸ˆè®²è´æ¯çš„å†…å­˜è®¾è®¡</a></p><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220410094632.png" class="img_PFMr"></p><p>è´æ¯åœ¨å†…å­˜ç®¡ç†çš„æ—¶å€™ï¼Œæ˜¯ä¸€ä¸ªä¸¤çº§çš„ç®¡ç†ï¼šç¬¬ä¸€çº§ï¼ŒKindç±»å‹ï¼Œè´æ¯åœ¨åˆ†é…çš„æ—¶å€™ä¼šåˆ†é…å‡ºå¾ˆå¤šç§ä¸åŒçš„ç±»å‹ã€‚</p><p>å¸¸è§çš„æœ‰ <code>PTRFREE</code>ï¼ˆæ— æŒ‡é’ˆç±»å‹ï¼‰ï¼Œ<code>Normal</code>ï¼ˆæ¯”è¾ƒä¸€èˆ¬çš„ç±»å‹ï¼‰ï¼Œè¿˜æœ‰ <code>Uncollectable</code>ï¼ˆä¸å¯å›æ”¶ç±»å‹ï¼‰ï¼Œä¸€èˆ¬æ˜¯è´æ¯è‡ªå·±è¦ç”¨çš„ä¸€å—å†…å­˜ä¼šåˆ†é…åˆ° <code>Uncollectable</code>ã€‚</p><p>æ¯ä¸€ä¸ªç±»å‹æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œåœ¨åˆ—è¡¨ä¸‹é¢åˆ†åˆ«ä¼šæŒ‚ä¸€ä¸ªäºŒçº§åˆ—è¡¨ï¼Œå»æ ‡æ˜å½“å‰è¿™ä¸€å—å†…å­˜å—ä¸‹é¢çš„å¤§å°ï¼Œåœ¨ç¬¬äºŒå±‚çš„ä¸‹é¢æŒ‚ç€ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨é‡Œè¾¹æ¯ä¸€å—å°±æ˜¯å¯¹åº”ä¸Šé¢å¤§å°çš„ä¸€å°å—å†…å­˜ã€‚</p><p>å›¾ä¸­ä¸¤ä¸ª <code>Block0</code> æ˜¯ç‰©ç†è¿æ¥çš„ï¼Œè¿™ä¸¤å—ç‰©ç†åœ°å€æ˜¯è¿ç»­çš„ï¼Œå‡å¦‚ç°åœ¨è¦å›æ”¶ä¸¤ä¸ª <code>Block0</code> ï¼Œå½“è¿™ä¸¤å—å†…å­˜éƒ½è¢«é‡Šæ”¾æ‰çš„æ—¶å€™ï¼Œ<code>Unity</code>ä¼šå°è¯•å»æ‰¾ä¸¤å—ï¼Œæ¯”å¦‚è¯´é‡Šæ”¾ç¬¬ä¸€å—ï¼Œ<code>Unity</code>å‘ç°åè¾¹çš„ç‰©ç†å†…å­˜ä¹Ÿæ˜¯è¢«é‡Šæ”¾æ‰çš„ã€‚</p><p>ä¾¿æŠŠä¸¤å—åˆå¹¶èµ·æ¥ï¼Œè®©æŒ‡é’ˆç›´æ¥æŒ‚åˆ°æ›´å¤§çš„åœ°æ–¹å»ï¼Œä»è€Œå°½é‡å‡å°‘æ•´ä½“å†…å­˜ç¢ç‰‡çš„å‘ç”Ÿã€‚è¿™ä¸ªç­–ç•¥èƒ½ç†è§£ä¸ºå°½é‡ä¼šæŠŠç©ºé—²å‡ºæ¥çš„å†…å­˜åˆå¹¶æˆä¸€ä¸ªè¾ƒå¤§çš„å†…å­˜å—ï¼ŒåŒæ—¶åœ¨ä»¥ç§»åŠ¨æŒ‡é’ˆçš„æ–¹å¼ã€‚</p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="heap-layout">Heap layout<a class="hash-link" href="#heap-layout" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200042.png" class="img_PFMr"></p><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å †å¸ƒå±€">å †å¸ƒå±€<a class="hash-link" href="#å †å¸ƒå±€" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="meta-data">Meta-data<a class="hash-link" href="#meta-data" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Need mark bit for each object.</li><li>Information for pointer validity &amp; object size, etc.</li><li>Support discontiguous heaps</li><li>Options for mark bits:<ul><li><em>In object:</em><ul><li><em>Objects: must be aligned.</em></li><li><em>Stealing a bit may require a word.</em> </li></ul></li><li><em>At beginning of each block:</em><ul><li><em>All mark bits are mapped to few cache lines.</em></li><li><em>Must touch pages with pointer-free objects.</em></li></ul></li><li>In separate data structure.<ul><li>More instructions for each access.</li><li>Pointer-free pages are not touched, fewer cache issues.</li></ul></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å…ƒæ•°æ®">å…ƒæ•°æ®<a class="hash-link" href="#å…ƒæ•°æ®" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>æ¯ä¸ªå¯¹è±¡éƒ½éœ€è¦æ ‡è®°ä½ã€‚</li><li>æŒ‡é’ˆæœ‰æ•ˆæ€§å’Œå¯¹è±¡å¤§å°ç­‰ä¿¡æ¯ã€‚</li><li>æ”¯æŒä¸è¿ç»­å †</li><li>æ ‡è®°ä½çš„é€‰é¡¹ï¼š<ul><li><em>åœ¨å¯¹è±¡ä¸­ï¼š</em><ul><li><em>å¯¹è±¡ï¼šå¿…é¡»å¯¹é½ã€‚</em></li><li><em>çªƒå–ä¸€ä¸ªå­—èŠ‚å¯èƒ½éœ€è¦ä¸€ä¸ªå•è¯ã€‚</em></li></ul></li><li><em>åœ¨æ¯ä¸ªå—çš„å¼€å¤´ï¼š</em><ul><li><em>æ‰€æœ‰æ ‡è®°ä½éƒ½æ˜ å°„åˆ°å‡ ä¸ªé«˜é€Ÿç¼“å­˜è¡Œã€‚</em></li><li><em>å¿…é¡»ä½¿ç”¨æ— æŒ‡é’ˆå¯¹è±¡è§¦æ‘¸<code>page</code>ã€‚</em></li></ul></li><li>åœ¨å•ç‹¬çš„æ•°æ®ç»“æ„ä¸­ã€‚<ul><li>æ¯æ¬¡è®¿é—®éƒ½æœ‰æ›´å¤šè¯´æ˜ã€‚</li><li>æ— æŒ‡é’ˆ<code>page</code>ä¸ä¼šè¢«è§¦ç¢°ï¼Œç¼“å­˜é—®é¢˜æ›´å°‘ã€‚</li></ul></li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="meta-data-lookup">Meta-data lookup<a class="hash-link" href="#meta-data-lookup" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200112.png" class="img_PFMr"></p><ul><li><code>Page descriptor</code>: é¡µé¢æè¿°ç¬¦</li><li><code>Mark bits</code>: æ ‡è®°ä½</li><li><code>Offset Map(later)</code>: åç§»è¡¨ï¼ˆå»¶è¿Ÿï¼‰ </li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="pointer-validity-check">Pointer validity check<a class="hash-link" href="#pointer-validity-check" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Get page descriptor. Valid heap page?<ul><li>About three memory references.<ul><li>Simple top level hashing scheme for 64-bit addresses.</li></ul></li><li>Two with a small cache.</li></ul></li><li>If not first page of object, adjust.</li><li>Valid offset in valid object?<ul><li>Remainder computation on offset in page gives object start.</li><li>Remainder can be looked up in table of &quot;valid offsets&quot;.</li><li>Allows pointers to only certain offsets in object to be considered valid. Check is constant time.</li><li>Small constant number of memory references.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="æŒ‡é’ˆæœ‰æ•ˆæ€§æ£€æŸ¥">æŒ‡é’ˆæœ‰æ•ˆæ€§æ£€æŸ¥<a class="hash-link" href="#æŒ‡é’ˆæœ‰æ•ˆæ€§æ£€æŸ¥" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>è·å–é¡µé¢æè¿°ç¬¦ã€‚æœ‰æ•ˆçš„å †<code>page</code>ï¼Ÿ<ul><li>å¤§çº¦ä¸‰æ¬¡å†…å­˜å¼•ç”¨ã€‚<ul><li>64ä½åœ°å€åªæ˜¯ä¸€ä¸ªç®€å•é¡¶å±‚å“ˆå¸Œæ–¹æ¡ˆã€‚</li></ul></li><li>ä¸¤ä¸ªå¸¦æœ‰å°ç¼“å­˜ã€‚</li></ul></li><li>å¦‚æœä¸æ˜¯å¯¹è±¡çš„ç¬¬ä¸€<code>page</code>ï¼Œè¯·è°ƒæ•´ã€‚</li><li>æœ‰æ•ˆå¯¹è±¡ä¸­çš„æœ‰æ•ˆåç§»é‡ï¼Ÿ<ul><li>é¡µä¸­åç§»é‡çš„ä½™æ•°è®¡ç®—ä½¿å¯¹è±¡å¼€å§‹ã€‚</li><li>å‰©ä½™éƒ¨åˆ†å¯åœ¨&quot;æœ‰æ•ˆåç§»&quot;è¡¨ä¸­æŸ¥æ‰¾ã€‚</li><li>åªå…è®¸æŒ‡å‘å¯¹è±¡ä¸­æŸäº›åç§»é‡çš„æŒ‡é’ˆè¢«è§†ä¸ºæœ‰æ•ˆã€‚æ£€æŸ¥æ˜¯å›ºå®šæ—¶é—´ã€‚</li><li>å°‘é‡æ’å®šæ•°é‡çš„å†…å­˜å¼•ç”¨ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="partial-pointer-location-type-information">Partial pointer location (type) information.<a class="hash-link" href="#partial-pointer-location-type-information" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>It&#x27;s often easy to determine location of pointers in heap objects (e.g. gcj (Java), Mono (.Net)).</li><li>Collector provides different allocation calls to communicate this.</li><li>Objects are segregated both by size and kind.</li><li>Each kind has associated object descriptor:<ul><li>First n fields are pointers.</li><li>30- or 62-bit bitmap identifies pointer locations.</li><li>Client specified mark procedure.</li><li>Indirect: descriptor is in object or vtable.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="éƒ¨åˆ†æŒ‡é’ˆä½ç½®ç±»å‹ä¿¡æ¯">éƒ¨åˆ†æŒ‡é’ˆä½ç½®ï¼ˆç±»å‹ï¼‰ä¿¡æ¯ã€‚<a class="hash-link" href="#éƒ¨åˆ†æŒ‡é’ˆä½ç½®ç±»å‹ä¿¡æ¯" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>ç¡®å®šå †å¯¹è±¡ä¸­æŒ‡é’ˆçš„ä½ç½®é€šå¸¸å¾ˆå®¹æ˜“ï¼ˆä¾‹å¦‚<code>GCJï¼ˆJavaï¼‰</code>ã€<code>Monoï¼ˆ.Netï¼‰</code>ï¼‰ã€‚</li><li>å›æ”¶å™¨æä¾›ä¸åŒçš„åˆ†é…è°ƒç”¨æ¥è¿›è¡Œé€šä¿¡ã€‚</li><li>å¯¹è±¡æ˜¯æŒ‰å¤§å°å’Œç§ç±»åˆ†å¼€çš„ã€‚</li><li>æ¯ç§ç±»å‹éƒ½æœ‰å…³è”çš„å¯¹è±¡æè¿°ç¬¦ï¼š<ul><li>å‰ <code>n</code> ä¸ªå­—æ®µæ˜¯æŒ‡é’ˆã€‚</li><li>30ä½æˆ–62ä½ä½å›¾æ ‡è¯†æŒ‡é’ˆä½ç½®ã€‚</li><li>å®¢æˆ·æŒ‡å®šçš„æ ‡è®°ç¨‹åºã€‚</li><li>é—´æ¥ï¼šæè¿°ç¬¦ä½äºå¯¹è±¡æˆ–<code>vtable</code>ä¸­ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="locating-roots">Locating roots<a class="hash-link" href="#locating-roots" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>By default roots consist of:<ul><li>Registers</li><li>Runtime stack(s)</li><li>Statically allocated data regions<ul><li>Main program + dynamic libraries</li></ul></li></ul></li><li><strong>How do we get their contents/location?</strong><ul><li><strong>Registers: abuse setjmp, __builtin_unwind_init, ...</strong></li><li><strong>Runtime stack(s): you don&#x27;t really want to know.</strong><ul><li><strong>Need consistent caller-save reg. snapshot</strong></li></ul></li><li><strong>Static data segments: you don&#x27;t want to know that either.</strong></li><li><strong>Very platform dependent</strong><ul><li><strong>But you only have to do it once per platform.</strong></li></ul></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å®šä½æ ¹">å®šä½æ ¹<a class="hash-link" href="#å®šä½æ ¹" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ¹<code>roots set</code>åŒ…æ‹¬ï¼š<ul><li>å¯„å­˜å™¨</li><li>è¿è¡Œæ—¶æ ˆ</li><li>é™æ€åˆ†é…çš„æ•°æ®åŒºåŸŸ<ul><li>ä¸»ç¨‹åº + åŠ¨æ€åº“</li></ul></li></ul></li><li><strong>æˆ‘ä»¬å¦‚ä½•å¾—åˆ°ä»–ä»¬çš„ä½ç½®ï¼Ÿ</strong><ul><li><strong>å¯„å­˜å™¨ï¼šæ»¥ç”¨<code>setjmp</code> <code>__builtin_unwind_init</code>...</strong></li><li><strong>è¿è¡Œæ—¶æ ˆï¼šä½ å¹¶ä¸æƒ³çŸ¥é“ã€‚</strong><ul><li><strong>éœ€è¦ä¸€ä¸ªå›ºå®šçš„è°ƒç”¨è€…æ¥ä¿å­˜<code>reg.</code>å¿«ç…§</strong></li></ul></li><li><strong>é™æ€æ•°æ®æ®µï¼šä½ ä¹Ÿä¸æƒ³çŸ¥é“ã€‚</strong></li><li><strong>éå¸¸ä¾èµ–å¹³å°</strong><ul><li><strong>ä½†æ¯ä¸ªå¹³å°æ‚¨åªéœ€æ‰§è¡Œä¸€æ¬¡ã€‚</strong></li></ul></li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="basic-mark-algorithm">Basic mark algorithm<a class="hash-link" href="#basic-mark-algorithm" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Maintain explicit mark stack of pairs:
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200205.png" class="img_PFMr"></li><li>Initially:<ul><li>For each individual root, push object.</li><li>For each root range, push range.</li></ul></li><li>Then repeatedly:<ul><li>Pop (addr, descr) pair from stack.</li><li>For each possible pointer in memory described by pair:<ul><li>Check pointer validity. If valid and unmarked:</li><li>Set mark bit for target. (Already have page descriptor.)</li><li>Push object address and descriptor (from page descriptor)</li></ul></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="åŸºæœ¬æ ‡è®°ç®—æ³•">åŸºæœ¬æ ‡è®°ç®—æ³•<a class="hash-link" href="#åŸºæœ¬æ ‡è®°ç®—æ³•" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>ç»´æŠ¤æ˜¾å¼æ ‡è®°æ ˆå¯¹(<code>key</code>, <code>value</code>)ï¼š
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200205.png" class="img_PFMr"></li><li>æœ€åˆï¼š<ul><li>å¯¹äºæ¯ä¸ªå•ç‹¬çš„æ ¹(<code>roots set</code>)ï¼Œæ¨å…¥å¯¹è±¡ã€‚</li><li>å¯¹äºæ¯ä¸ªæ ¹èŒƒå›´ï¼Œæ¨å…¥æ•´ä¸ªæ ¹èŒƒå›´ã€‚</li></ul></li><li>ç„¶ååå¤è¯´ï¼š<ul><li>ä»æ ˆä¸­å¼¹å‡ºï¼ˆ<code>addr</code>ï¼Œ<code>descr</code>ï¼‰å¯¹ã€‚</li><li>å¯¹äºç”± <code>pair</code> æè¿°çš„å†…å­˜ä¸­æ¯ä¸ªå¯èƒ½çš„æŒ‡é’ˆï¼š<ul><li>æ£€æŸ¥æŒ‡é’ˆçš„æœ‰æ•ˆæ€§ã€‚å¦‚æœæœ‰æ•ˆä¸”æœªæ ‡è®°ï¼š</li><li>ä¸ºç›®æ ‡è®¾ç½®æ ‡è®°ä½ã€‚ï¼ˆå·²ç»æœ‰é¡µé¢æè¿°ç¬¦ã€‚ï¼‰</li><li>æ¨å…¥å¯¹è±¡åœ°å€å’Œæè¿°ç¬¦ï¼ˆä»é¡µé¢æè¿°ç¬¦ï¼‰</li></ul></li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="marker-refinements">Marker refinements<a class="hash-link" href="#marker-refinements" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Tune as much as possible.<ul><li>This is where the GC spends its time.</li></ul></li><li>It&#x27;s the memory accesses that matter.<ul><li>Prefetch object as we push its descriptor on stack.</li><li>May save 1/3 of mark time.</li></ul></li><li>Range check possible pointers for plausibility first.<ul><li>Eliminates almost all non-pointers.</li></ul></li><li>Minor benefit from keeping cache of recently looked up block descriptors.<ul><li>Probably more important for 64 bit platforms.</li><li>But uncached lookup is already fast.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="æ ‡è®°æ”¹è¿›">æ ‡è®°æ”¹è¿›<a class="hash-link" href="#æ ‡è®°æ”¹è¿›" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>å°½é‡è°ƒã€‚<ul><li>è¿™æ˜¯<code>GC</code>èŠ±è´¹æ—¶é—´çš„åœ°æ–¹ã€‚</li></ul></li><li>é‡è¦çš„æ˜¯å†…å­˜è®¿é—®ã€‚<ul><li>å½“æˆ‘ä»¬å°†å…¶æè¿°ç¬¦å‹å…¥å †æ—¶é¢„å–å¯¹è±¡ã€‚</li><li>å¯ä»¥èŠ‚çœ 1/3 ä¸ªæ ‡è®°æ—¶é—´ã€‚</li></ul></li><li>èŒƒå›´é¦–å…ˆæ£€æŸ¥å¯èƒ½çš„æŒ‡é’ˆçš„åˆç†æ€§ã€‚<ul><li>æ¶ˆé™¤äº†å‡ ä¹æ‰€æœ‰çš„éæŒ‡é’ˆã€‚</li></ul></li><li>ä¿ç•™æœ€è¿‘æŸ¥æ‰¾çš„å—æè¿°ç¬¦çš„ç¼“å­˜å¸¦æ¥çš„å°å¥½å¤„ã€‚<ul><li>å¯¹äº64ä½å¹³å°å¯èƒ½æ›´é‡è¦ã€‚</li><li>ä½†æ— ç¼“å­˜æŸ¥æ‰¾å·²ç»å¾ˆå¿«äº†ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="the-marker-core-version-pre-70">The marker core (version pre-7.0)<a class="hash-link" href="#the-marker-core-version-pre-70" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ol><li>Retrieve mark descriptor from stack.</li><li>(Possibly retrieve &quot;indirect&quot; descriptor from object.)</li><li>Look for pointers in object satisfying range check. Immediately prefetch at that address.</li><li>For each likely nested pointer, processing first one last:<ul><li>Look up header in cache (2 memory references).</li><li>Get offset from beginning of block.</li><li>Divide by object size to get object start, and displacement in object.</li><li>If displacement is nonzero, check table for validity.</li><li>Check mark bit in header.</li><li>If not set, set it, get descriptor from block header, push entry on mark stack.</li></ul></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="æ ‡è®°å™¨æ ¸å¿ƒ70ä¹‹å‰çš„ç‰ˆæœ¬">æ ‡è®°å™¨æ ¸å¿ƒï¼ˆ7.0ä¹‹å‰çš„ç‰ˆæœ¬ï¼‰<a class="hash-link" href="#æ ‡è®°å™¨æ ¸å¿ƒ70ä¹‹å‰çš„ç‰ˆæœ¬" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ol><li>ä»æ ˆä¸­æ£€ç´¢æ ‡è®°æè¿°ç¬¦ã€‚</li><li>ï¼ˆå¯èƒ½ä»å¯¹è±¡ä¸­æ£€ç´¢&quot;é—´æ¥&quot;æè¿°ç¬¦ã€‚ï¼‰</li><li>åœ¨æ»¡è¶³èŒƒå›´æ£€æŸ¥çš„å¯¹è±¡ä¸­å¯»æ‰¾æŒ‡é’ˆã€‚ç«‹å³é¢„å–è¯¥åœ°å€ã€‚</li><li>å¯¹äºæ¯ä¸ªå¯èƒ½çš„åµŒå¥—æŒ‡é’ˆï¼Œæœ€åå¤„ç†ç¬¬ä¸€ä¸ªï¼š<ul><li>åœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾æ ‡å¤´ï¼ˆ2ä¸ªå†…å­˜å¼•ç”¨ï¼‰ã€‚</li><li>ä»å—çš„å¼€å¤´è·å¾—åç§»é‡ã€‚</li><li>é™¤ä»¥å¯¹è±¡å¤§å°ä»¥è·å¾—å¯¹è±¡å¼€å§‹å’Œå¯¹è±¡ä¸­çš„ä½ç§»ã€‚</li><li>å¦‚æœä½ç§»ä¸ä¸ºé›¶ï¼Œæ£€æŸ¥è¡¨çš„æœ‰æ•ˆæ€§ã€‚</li><li>æ£€æŸ¥å¤´éƒ¨çš„æ ‡è®°ä½ã€‚</li><li>å¦‚æœæœªè®¾ç½®ï¼Œåˆ™è®¾ç½®å®ƒï¼Œä»å—å¤´è·å–æè¿°ç¬¦ï¼Œå°†æ¡ç›®æ¨å…¥æ ‡è®°æ ˆä¸Šã€‚</li></ul></li></ol><p>è¿™é‡Œå¾ˆå¤§ä¸€ä¸ªç¯‡å¹…åœ¨æå†™æ ˆ. ä½†æè¿°çš„æ˜¯æ ‡è®°å™¨</p><p>ä»¥ä¸‹æ˜¯åˆ†é…å™¨çš„ç›¸å…³æè¿°, åˆå¹¶å‚è€ƒ:</p><p><a href="https://www.bilibili.com/video/BV1r44y1z7X3?p=2&amp;t=13m25s" target="_blank" rel="noopener noreferrer">é«˜å·è€å¸ˆè®²æ ˆåˆ†é…å™¨</a></p><p>æ ˆåˆ†é…å™¨æœ‰ä¸‰ä¸ªç‰¹ç‚¹:</p><ul><li>ç¬¬ä¸€ä¸ªæ˜¯ç‰¹åˆ«åœ°å¿«ï¼Œ</li><li>ç¬¬äºŒä¸ªæ˜¯ç‰¹åˆ«åœ°å°ï¼Œ</li><li>ç¬¬ä¸‰ä¸ªæ˜¯ä¸´æ—¶ï¼Œ</li></ul><p>åˆ†é…å™¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯ç”¨æ¥åˆ†é…ä¸´æ—¶å˜é‡ã€‚</p><p>å½“è¦å»åˆ†é…ä¸€å—å†…å­˜çš„æ—¶å€™ï¼Œå®é™…ä¸Š <code>Unity</code> å¸®å¿™åˆ†é…äº†ä¸¤å—å†…å­˜ã€‚</p><ul><li>ç¬¬ä¸€å—æ˜¯<code>header</code>ï¼Œè®°å½•äº†å½“å‰è¿™ä¸€æ¬¡åˆ†é…çš„ä¸€äº›ä¿¡æ¯ã€‚æ¯”å¦‚ï¼šæŸä¸€å—å½“å‰æ˜¯ä¸æ˜¯è¦è¢«åˆ æ‰ï¼Œæ˜¯ä¸æ˜¯è¿˜åœ¨ç”¨ï¼›çœŸæ­£ç»™ç”¨æˆ·çš„åŒºåŸŸå¤§å°ï¼›æ¯”å¦‚è¯´å½“å‰å—çš„å‰é¢ä¸€å—æ˜¯è°ã€‚</li><li><code>Header</code>ä¸‹é¢æ‰æ˜¯ç¬¬äºŒå—ï¼Œå³ç”¨æˆ·çš„åˆ†é…ä½¿ç”¨åŒºåŸŸã€‚è¿™ä¸€æ•´å—å†…å­˜æ˜¯åœ¨ä¸€å¼€å§‹å°±å·²ç»é¢„å…ˆåˆ†é…å¥½çš„ï¼Œåœ¨è¿›è¡Œæ ˆåˆ†é…çš„æ—¶å€™ï¼Œåªæ˜¯åœ¨ä¸åœçš„è°ƒæ•´æ ˆé¡¶æŒ‡é’ˆï¼Œä¾æ¬¡å‘ä¸‹åˆ†é…ï¼Œæ¯ä¸€æ¬¡åªåœ¨æ ˆçš„é¡¶ç«¯ï¼Œä¹Ÿå°±æ˜¯è¿™å—å†…å­˜çš„å°¾éƒ¨å†å»åˆ†é…ã€‚</li></ul><p>å½“æ•´ä¸ªé¢„å…ˆåˆ†é…æ ˆå†…å­˜è¢«æ¶ˆè€—å¹²å‡€äº†ä¹‹åï¼Œè¿˜ä¼šé¢å¤–çš„æ‹“å±•å‡ºä¸€å—æ–°çš„ï¼Œè¿™ä¸ªæ‹“å±•ä¸æ˜¯æ— é™çš„è€Œæ˜¯æœ‰ä¸€ä¸ªå¤§å°çš„é™åˆ¶ã€‚</p><p>åœ¨å›æ”¶å†…å­˜æ—¶ï¼Œé¦–å…ˆæŠŠè¿™å—å†…å­˜çš„ <code>deleted</code> çš„åœ¨ <code>Header</code> é‡Œè¾¹æ ‡è®°æˆ1ï¼Œè¡¨ç¤ºè¿™ä¸€å—å†…å­˜å·²ç»æ— ç”¨äº†ï¼Œå†æ ˆé¡¶æŒ‡é’ˆå›å¼¹å°±å¯ä»¥äº†ï¼Œè¿™æ ·æ˜¯éå¸¸å¿«çš„ã€‚åˆ†é…å’Œå›æ”¶ä¸€æ ·éƒ½æ˜¯æŒªæ ˆæŒ‡é’ˆï¼Œæ‰€ä»¥åˆ†é…å’Œå›æ”¶éƒ½éå¸¸åœ°å¿«ã€‚</p><p>å¦‚æœå›æ”¶çš„ä½ç½®æ˜¯ä¸­é—´è€Œä¸æ˜¯å†…å­˜å—çš„å°¾å·´ï¼Œåªéœ€è¦æŠŠå¤´çš„è¿™ä¸ª <code>deleted</code> çš„æ ‡è®°æˆ1ï¼Œä¹Ÿå°±æ˜¯æ ‡è®°ä¸Šå·²ç»åˆ é™¤äº†ï¼Œç›´åˆ°å°¾å·´è¢«å›æ”¶ï¼Œåœ¨æ ˆé¡¶æŒ‡é’ˆå›å¼¹çš„æ—¶å€™ï¼Œä¼šå»å†æ£€æŸ¥å½“å‰è¿™ä¸€å—æ˜¯ä¸æ˜¯ä¹Ÿè¢«åˆ é™¤äº†ï¼Œ</p><p>å¦‚æœæ˜¯ï¼Œæ ˆé¡¶æŒ‡é’ˆå†æ¬¡å‘ä¸Šç§»åŠ¨ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰è¢«åˆ é™¤çš„å—ï¼Œæˆ–è€…æ˜¯æŒªåˆ°äº† <code>Header</code>ï¼Œè¿™æ ·å°±å¯¼è‡´å¦‚æœå°¾å·´å¤„çš„å†…å­˜ä¸€ç›´æ²¡æœ‰é‡Šæ”¾ï¼Œä¸­é—´å·²ç»é‡Šæ”¾çš„å†…å­˜å—æ— æ³•å†æ¬¡ä½¿ç”¨ï¼Œè¿™å°±æ˜¯æ ˆåˆ†é…å™¨çš„ä¸€ä¸ªé™åˆ¶ï¼Œå®ƒæ— æ³•å¿«é€Ÿç«‹åˆ»å»é‡ç”¨å·²ç»é‡Šæ”¾çš„å†…å­˜ï¼Œå®ƒå¿…é¡»è¦ç­‰æ ˆé¡¶è¢«é‡Šæ”¾çš„æ—¶å€™ï¼Œæ‰èƒ½å‘å›å»å¯»æ‰¾è¿™äº›è¿ç»­å†…å­˜ã€‚</p><blockquote><p>å½“å› ä¸ºä½ çš„æ•°æ®é‡å¤ªå¤§ï¼ŒæŠŠæ‹¥æŒ¤çš„ä¸´æ—¶å †æ ˆæ’‘çˆ†äº†ï¼Œæœ‰ä¸¤ç§æ–¹æ³•è§£å†³ï¼š</p></blockquote><ol><li>å»å‡å°‘ä½ ä»¬æ¯ä¸€å¸§çš„æ•°æ®é‡ã€‚</li><li>é€šè¿‡Unityæºç ï¼ŒæŠŠå †æ ˆåŠ å¤§ä¸€ç‚¹ã€‚</li></ol><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="marker-performance-why-gc-needs-a-fast-multiplier">Marker performance: Why GC needs a fast multiplier.<a class="hash-link" href="#marker-performance-why-gc-needs-a-fast-multiplier" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li><strong>On toy benchmark, small objects., 1x1.4GHz Itanium</strong><ul><li><strong>500MB/sec (Peak mem. Bandwidth 6.4GB/sec.)</strong></li><li><strong>About 90 cycles/object. (L3 cache miss ~200cycles)</strong></li></ul></li><li><strong>About 260MB/sec, 180 cycles/object on a 2GHz Xeon.</strong></li><li>Cache misses matter a lot.</li><li>Divisions are a problem.<ul><li>Can easily multiply by reciprocal.</li><li>Integer multiply has around 15 cycles latency on IA64.<ul><li>Similar on Pentium 4?</li></ul></li><li>Very hard to hide latency.</li><li>Table lookup of remainder, mark bit per allocation granule (not object)
wins (~20% on P4 Xeon).</li></ul></li><li>Could we do multiple header lookups &amp; divisions at once to hide latency? Maybe</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="æ ‡è®°å™¨æ€§èƒ½ä¸ºä»€ä¹ˆ-gc-éœ€è¦å¿«é€Ÿä¹˜æ³•å™¨">æ ‡è®°å™¨æ€§èƒ½ï¼šä¸ºä»€ä¹ˆ <code>GC</code> éœ€è¦å¿«é€Ÿä¹˜æ³•å™¨<a class="hash-link" href="#æ ‡è®°å™¨æ€§èƒ½ä¸ºä»€ä¹ˆ-gc-éœ€è¦å¿«é€Ÿä¹˜æ³•å™¨" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li><strong>åœ¨ç©å…·åŸºå‡†æµ‹è¯•ä¸­ï¼Œå°å¯¹è±¡ï¼Œ<code>1x1.4GHz</code> å®‰è…¾</strong><ul><li><strong><code>500MB/s</code>ï¼ˆå³°å€¼å†…å­˜ã€‚å¸¦å®½ <code>6.4GB/s</code>ã€‚ï¼‰</strong></li><li><strong>å¤§çº¦ 90 ä¸ªå‘¨æœŸ/å¯¹è±¡ã€‚ï¼ˆ<code>L3</code> ç¼“å­˜æœªå‘½ä¸­ <code>~200cycles</code>ï¼‰</strong></li></ul></li><li><strong>åœ¨ <code>2GHz Xeon</code> ä¸Šå¤§çº¦ <code>260MB/s</code>ï¼Œ180 ä¸ªå‘¨æœŸ/å¯¹è±¡ã€‚</strong></li><li>ç¼“å­˜æœªå‘½ä¸­å¾ˆé‡è¦ã€‚</li><li>åˆ†å·¥æ˜¯ä¸ªé—®é¢˜ã€‚<ul><li>å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¹˜ä»¥å€’æ•°ã€‚</li><li>æ•´æ•°ä¹˜æ³•åœ¨ <code>IA64</code> ä¸Šæœ‰å¤§çº¦ 15 ä¸ªå‘¨æœŸçš„å»¶è¿Ÿã€‚<ul><li><code>Pentium 4</code> ç±»ä¼¼å—ï¼Ÿ</li></ul></li><li>å¾ˆéš¾éšè—å»¶è¿Ÿã€‚</li><li>ä½™æ•°çš„è¡¨æŸ¥æ‰¾ï¼Œæ¯ä¸ªåˆ†é…é¢—ç²’ï¼ˆéå¯¹è±¡ï¼‰çš„æ ‡è®°ä½è·èƒœï¼ˆåœ¨ <code>P4 Xeon</code> ä¸Šçº¦ä¸º 20%ï¼‰ã€‚</li></ul></li><li>æˆ‘ä»¬å¯ä»¥ä¸€æ¬¡è¿›è¡Œå¤šä¸ªæ ‡å¤´æŸ¥æ‰¾å’Œåˆ’åˆ†ä»¥éšè—å»¶è¿Ÿå—ï¼Ÿä¹Ÿè®¸</li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="what-if-the-mark-stack-overflows">What if the mark stack overflows?<a class="hash-link" href="#what-if-the-mark-stack-overflows" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li><strong>Likely as you approach memory limit.</strong></li><li><strong>Programmers expect to be able to recover from running out-of-memory</strong> <ul><li><strong>... although it is almost never 100% reliable, GC or not.</strong></li></ul></li><li>We<ul><li>Drop part of stack.</li><li>Set overflowed flag.</li></ul></li><li>If flag is set at end of mark phase:<ul><li>Rescan heap. Look for marked -&gt; unmarked pointers.</li><li>Mark again from such targets.</li><li>Repeat if necessary.</li><li>Grow mark stack if possible.</li></ul></li><li>Never push large number of entries without setting a mark bit.<ul><li>Ensures forward progress.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å¦‚æœæ ‡è®°å †æ ˆæº¢å‡º">å¦‚æœæ ‡è®°å †æ ˆæº¢å‡º<a class="hash-link" href="#å¦‚æœæ ‡è®°å †æ ˆæº¢å‡º" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li><strong>å¯èƒ½å½“æ‚¨æ¥è¿‘å†…å­˜é™åˆ¶æ—¶ã€‚</strong></li><li><strong>ç¨‹åºå‘˜å¸Œæœ›èƒ½å¤Ÿä»å†…å­˜ä¸è¶³ä¸­æ¢å¤</strong><ul><li><strong>â€¦â€¦å°½ç®¡å®ƒå‡ ä¹ä»æ¥éƒ½ä¸æ˜¯ 100% å¯é çš„ï¼Œä¸ç®¡ <code>GC</code> ä¸å¦ã€‚</strong></li></ul></li><li>æˆ‘ä»¬<ul><li>åˆ é™¤å †æ ˆçš„ä¸€éƒ¨åˆ†ã€‚</li><li>è®¾ç½®æº¢å‡ºæ ‡å¿—ã€‚</li></ul></li><li>å¦‚æœåœ¨æ ‡è®°é˜¶æ®µç»“æŸæ—¶è®¾ç½®äº†æ ‡å¿—ï¼š<ul><li>é‡æ–°æ‰«æå †ã€‚å¯»æ‰¾æ ‡è®° -&gt; æœªæ ‡è®°çš„æŒ‡é’ˆã€‚</li><li>ä»è¿™äº›ç›®æ ‡å†æ¬¡æ ‡è®°ã€‚</li><li>å¿…è¦æ—¶é‡å¤ã€‚</li><li>å¦‚æœå¯èƒ½ï¼Œå¢åŠ æ ‡è®°å †æ ˆã€‚</li></ul></li><li>åˆ‡å‹¿åœ¨æœªè®¾ç½®æ ‡è®°ä½çš„æƒ…å†µä¸‹æ¨é€å¤§é‡æ¡ç›®ã€‚<ul><li>ç¡®ä¿å‰è¿›ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="the-sweep-phase">The &quot;sweep phase&quot;<a class="hash-link" href="#the-sweep-phase" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Sweep large objects and completely empty pages eagerly.</li><li>Completely empty pages are easily detectable and surprisingly common.<ul><li>Effectively coalesces some small objects very cheaply.</li></ul></li><li>Sweep small object pages when we encounter an empty free list.</li><li>Separate pages can be swept in parallel.</li><li>Empirically, execution time is almost always dominated by marker.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="æ¸…é™¤é˜¶æ®µ">æ¸…é™¤é˜¶æ®µ<a class="hash-link" href="#æ¸…é™¤é˜¶æ®µ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>æ€¥åˆ‡åœ°æ‰«æå¤§å¯¹è±¡å’Œå®Œå…¨æ¸…ç©ºé¡µé¢ã€‚</li><li>å®Œå…¨ç©ºç™½çš„é¡µé¢å¾ˆå®¹æ˜“è¢«æ£€æµ‹åˆ°å¹¶ä¸”éå¸¸æ™®éã€‚<ul><li>éå¸¸ä¾¿å®œåœ°æœ‰æ•ˆåœ°åˆå¹¶ä¸€äº›å°å¯¹è±¡ã€‚</li></ul></li><li>å½“æˆ‘ä»¬é‡åˆ°ä¸€ä¸ªç©ºçš„ç©ºé—²åˆ—è¡¨æ—¶ï¼Œæ‰«æå°å¯¹è±¡é¡µé¢ã€‚</li><li>å¯ä»¥å¹¶è¡Œæ‰«æå•ç‹¬çš„é¡µé¢ã€‚</li><li>æ ¹æ®ç»éªŒï¼Œæ‰§è¡Œæ—¶é—´å‡ ä¹æ€»æ˜¯ç”±æ ‡è®°æ”¯é…ã€‚</li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="thread-support">Thread support<a class="hash-link" href="#thread-support" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Uncontrolled concurrent mutation of data structures can cause objects to be overlooked by marker:
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200333.png" class="img_PFMr"></li><li>Results in reclaimed reachable objects.</li><li>We stop threads during critical GC phases.<ul><li>Unlike most GCs, threads can be
stopped anywhere.</li></ul></li><li>On most platforms, we send each thread a signal, with handshake in handler.<ul><li>Ensures that thread is stopped.</li><li>Pushes register contents onto the (GC-visible) stack.</li></ul></li><li>Typically requires that thread creation calls be intercepted by GC.<ul><li>GC substitutes its own thread start routine.</li><li>Keeps track of threads, shadowing thread library.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="çº¿ç¨‹æ”¯æŒ">çº¿ç¨‹æ”¯æŒ<a class="hash-link" href="#çº¿ç¨‹æ”¯æŒ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>æ•°æ®ç»“æ„çš„ä¸å—æ§åˆ¶çš„å¹¶å‘çªå˜ä¼šå¯¼è‡´å¯¹è±¡è¢«æ ‡è®°å¿½ç•¥ï¼š
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200333.png" class="img_PFMr"></li><li>å¯¼è‡´å›æ”¶çš„å¯è¾¾å¯¹è±¡</li><li>æˆ‘ä»¬åœ¨å…³é”®çš„ <code>GC</code> é˜¶æ®µåœæ­¢çº¿ç¨‹ã€‚<ul><li>ä¸å¤§å¤šæ•° <code>GC</code> ä¸åŒï¼Œçº¿ç¨‹å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹åœæ­¢ã€‚</li></ul></li><li>åœ¨å¤§å¤šæ•°å¹³å°ä¸Šï¼Œæˆ‘ä»¬å‘æ¯ä¸ªçº¿ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œå¹¶åœ¨å¤„ç†ç¨‹åºä¸­è¿›è¡Œæ¡æ‰‹ã€‚<ul><li>ç¡®ä¿çº¿ç¨‹åœæ­¢ã€‚</li><li>å°†å¯„å­˜å™¨å†…å®¹æ¨é€åˆ°ï¼ˆ<code>GC</code> å¯è§çš„ï¼‰å †æ ˆä¸Šã€‚</li></ul></li><li>é€šå¸¸è¦æ±‚ <code>GC</code> æ‹¦æˆªçº¿ç¨‹åˆ›å»ºè°ƒç”¨ã€‚<ul><li><code>GC</code> æ›¿æ¢å®ƒè‡ªå·±çš„çº¿ç¨‹å¯åŠ¨ä¾‹ç¨‹ã€‚</li><li>è·Ÿè¸ªçº¿ç¨‹ï¼Œéšè—çº¿ç¨‹åº“ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="enhancement-1-black-listing">Enhancement 1: Black-listing<a class="hash-link" href="#enhancement-1-black-listing" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Conservative pointer-finding can cause memory retention:
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200419.png" class="img_PFMr"></li><li>In many cases, this is avoidable.<ul><li>If we see an address near future heap growth:
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200457.png" class="img_PFMr"></li><li>Don&#x27;t allocate at location 0x1a34c. </li><li>We track pages with bogus pointers to them.<ul><li>Marker updates list.</li><li>Allocate at most small pointer-free objects there.</li></ul></li></ul></li></ul><h3></h3><ul><li>ä¿å®ˆçš„æŒ‡é’ˆæŸ¥æ‰¾ä¼šå¯¼è‡´å†…å­˜ä¿ç•™ï¼š
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200419.png" class="img_PFMr"></li><li>åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè¿™æ˜¯å¯ä»¥é¿å…çš„ã€‚<ul><li>å¦‚æœæˆ‘ä»¬åœ¨ä¸ä¹…çš„å°†æ¥çœ‹åˆ°ä¸€ä¸ªåœ°å€å †å¢é•¿ï¼š
<img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200457.png" class="img_PFMr"></li><li>ä¸è¦åœ¨ä½ç½® <code>0x1a34c</code> åˆ†é…ã€‚</li><li>æˆ‘ä»¬è·Ÿè¸ªå¸¦æœ‰è™šå‡æŒ‡é’ˆçš„é¡µé¢ã€‚<ul><li>æ ‡è®°æ›´æ–°åˆ—è¡¨ã€‚</li><li>åœ¨é‚£é‡Œåˆ†é…æœ€å¤šå°çš„æ— æŒ‡é’ˆå¯¹è±¡ã€‚</li></ul></li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="black-listing-contd">Black-listing (contd.)<a class="hash-link" href="#black-listing-contd" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Can be substantial improvement, especially with large root sets containing
random, but static data.</li><li>Only dynamic data can cause retention.<ul><li>But dynamically created data is also more likely to disappear later.</li></ul></li><li><strong>Usually we see good results with conservative pointer finding, minimal layout information and</strong><ul><li><strong>32 bit address space, heaps up to a few 100MB, or</strong></li><li><strong>64-bit address space.</strong></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="é»‘åå•-ç»­">é»‘åå• (ç»­)<a class="hash-link" href="#é»‘åå•-ç»­" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>å¯ä»¥å¤§å¹…æ”¹è¿›ï¼Œå°¤å…¶æ˜¯å¯¹äºåŒ…å«éšæœºä½†é™æ€æ•°æ®çš„å¤§å‹æ ¹é›†ã€‚</li><li>åªæœ‰åŠ¨æ€æ•°æ®ä¼šå¯¼è‡´ä¿ç•™ã€‚<ul><li>ä½†æ˜¯åŠ¨æ€åˆ›å»ºçš„æ•°æ®ä¹Ÿæ›´æœ‰å¯èƒ½åœ¨ä»¥åæ¶ˆå¤±ã€‚</li></ul></li><li><strong>é€šå¸¸æˆ‘ä»¬ä¼šé€šè¿‡ä¿å®ˆçš„æŒ‡é’ˆæŸ¥æ‰¾ã€æœ€å°‘çš„å¸ƒå±€ä¿¡æ¯å’Œ</strong><ul><li><strong>32 ä½åœ°å€ç©ºé—´ï¼Œæœ€å¤šå¯å †åˆ° <code>100MB</code>ï¼Œæˆ–</strong></li><li><strong>64 ä½åœ°å€ç©ºé—´ã€‚</strong></li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="optional-enhancements">Optional enhancements<a class="hash-link" href="#optional-enhancements" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Remaining enhancements are (or were)
implemented and available, but not all combinable.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å¯é€‰å¢å¼ºåŠŸèƒ½">å¯é€‰å¢å¼ºåŠŸèƒ½<a class="hash-link" href="#å¯é€‰å¢å¼ºåŠŸèƒ½" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>å‰©ä½™çš„å¢å¼ºåŠŸèƒ½å·²ï¼ˆæˆ–æ›¾ç»ï¼‰å®æ–½å¹¶å¯ç”¨ï¼Œä½†å¹¶éå…¨éƒ¨å¯ç»„åˆã€‚</li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="generational-incremental-mostly-concurrent-gc">Generational, Incremental, Mostly Concurrent GC<a class="hash-link" href="#generational-incremental-mostly-concurrent-gc" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Observation:<ul><li>Running marker concurrently establishes invariant:<ul><li>Pointers from marked objects or roots either<ul><li>point to marked objects, or</li><li>were modified since object was marked.</li></ul></li></ul></li><li>Such a concurrent mark phase can be fixed if we can<ul><li>Identify possibly modified objects (and roots)</li><li>Mark again from modified objects.</li></ul></li><li><strong>Most generational collectors track modifications with a compiler introduced &quot;write barrier&quot;.</strong> </li><li><strong>We use the VM system, e.g.</strong><ul><li><strong>Write protect pages (e.g. mprotect for Linux)</strong></li><li><strong>Catch protection faults (e.g. SIGSEGV)</strong></li></ul></li><li><strong>Free if allocation is rare, but otherwise not ideal.</strong></li></ul></li><li>Mostly concurrent GC:<ul><li>Run concurrent marker once.</li><li>Run fixup marker zero or more times concurrently, preserving invariant, reducing # dirty objects. </li><li>Run fixup marker with threads stopped once. </li><li>Works, reduces pause times, used in other systems. </li><li>Scheduling tricky, requires threads.</li></ul></li><li><strong>Incremental GC:</strong><ul><li><strong>Do a little &quot;concurrent&quot; marking during some allocations.</strong> </li><li><strong>Amount of marking proportional to allocation.</strong></li><li><strong>Same pause time benefit, no throughput benefit.</strong></li></ul></li><li><strong>Generational GC:</strong><ul><li><strong>Leave mark bits set after &quot;full GC&quot;, but track dirty pages.</strong> </li><li><strong>&quot;Fixup GC&quot; is minor GC.</strong></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="åˆ†ä»£å¢é‡å¤§éƒ¨åˆ†å¹¶å‘">åˆ†ä»£ã€å¢é‡ã€å¤§éƒ¨åˆ†å¹¶å‘<a class="hash-link" href="#åˆ†ä»£å¢é‡å¤§éƒ¨åˆ†å¹¶å‘" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>è§‚å¯Ÿï¼š<ul><li>è¿è¡Œæ ‡è®°åŒæ—¶å»ºç«‹ä¸å˜é‡ï¼š<ul><li>æ¥è‡ªæ ‡è®°å¯¹è±¡æˆ–æ ¹çš„æŒ‡é’ˆ<ul><li>æŒ‡å‘æ ‡è®°çš„å¯¹è±¡ï¼Œæˆ–</li><li>è‡ªæ ‡è®°å¯¹è±¡ä»¥æ¥å·²ä¿®æ”¹ã€‚</li></ul></li></ul></li><li>å¦‚æœå¯ä»¥çš„è¯ï¼Œå¯ä»¥ä¿®å¤è¿™æ ·çš„å¹¶å‘æ ‡è®°é˜¶æ®µ<ul><li>è¯†åˆ«å¯èƒ½ä¿®æ”¹çš„å¯¹è±¡ï¼ˆå’Œæ ¹ï¼‰</li><li>ä»ä¿®æ”¹çš„å¯¹è±¡å†æ¬¡æ ‡è®°ã€‚</li></ul></li><li><strong>å¤§å¤šæ•°ä¸–ä»£æ”¶é›†å™¨ä½¿ç”¨å¼•å…¥â€œå†™å±éšœâ€çš„ç¼–è¯‘å™¨æ¥è·Ÿè¸ªä¿®æ”¹ã€‚</strong></li><li><strong>æˆ‘ä»¬ä½¿ç”¨VMç³»ç»Ÿï¼Œä¾‹å¦‚</strong><ul><li><strong>å†™ä¿æŠ¤é¡µé¢ï¼ˆä¾‹å¦‚ <code>Linux</code> çš„ <code>mprotect</code>ï¼‰</strong></li><li><strong>æ•è·ä¿æŠ¤æ•…éšœï¼ˆä¾‹å¦‚ <code>SIGSEGV</code>ï¼‰</strong></li></ul></li><li><strong>å¦‚æœåˆ†é…å¾ˆå°‘ï¼Œåˆ™å…è´¹ï¼Œå¦åˆ™ä¸ç†æƒ³ã€‚</strong></li></ul></li><li>ä¸»è¦æ˜¯å¹¶å‘<code>GC</code>ï¼š<ul><li>è¿è¡Œå¹¶å‘æ ‡è®°ä¸€æ¬¡ã€‚</li><li>åŒæ—¶è¿è¡Œä¿®æ­£æ ‡è®°é›¶æ¬¡æˆ–å¤šæ¬¡ï¼Œä¿æŒä¸å˜ï¼Œå‡å°‘#è„å¯¹è±¡ã€‚</li><li>åœ¨çº¿ç¨‹åœæ­¢ä¸€æ¬¡çš„æƒ…å†µä¸‹è¿è¡Œä¿®å¤æ ‡è®°ã€‚</li><li>å·¥ä½œï¼Œå‡å°‘æš‚åœæ—¶é—´ï¼Œç”¨äºå…¶ä»–ç³»ç»Ÿã€‚</li><li>è°ƒåº¦æ£˜æ‰‹ï¼Œéœ€è¦çº¿ç¨‹ã€‚</li></ul></li><li><strong>å¢é‡<code>GC</code>ï¼š</strong><ul><li><strong>åœ¨æŸäº›åˆ†é…æœŸé—´åšä¸€äº›â€œå¹¶å‘â€æ ‡è®°ã€‚</strong></li><li><strong>æ ‡è®°é‡ä¸åˆ†é…æˆæ­£æ¯”ã€‚</strong></li><li><strong>ç›¸åŒçš„æš‚åœæ—¶é—´ä¼˜åŠ¿ï¼Œæ²¡æœ‰ååé‡ä¼˜åŠ¿ã€‚</strong></li></ul></li><li><strong>åˆ†ä»£<code>GC</code>ï¼š</strong><ul><li><strong>åœ¨<code>â€œfull GCâ€</code>ä¹‹åè®¾ç½®æ ‡è®°ä½ï¼Œä½†è·Ÿè¸ªè„é¡µã€‚</strong></li><li><strong><code>â€œFixup GCâ€</code>æ˜¯æ¬¡è¦ <code>GC</code>ã€‚</strong></li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="parallel-marking--processor-scalability">Parallel marking &amp; processor scalability<a class="hash-link" href="#parallel-marking--processor-scalability" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>As client parallelism increases, eventually we spend all time in sequential
part of GC.</li><li>Sweeping is done a page at a time &amp; can be parallelized. What about marking?</li><li>Marking is also quite parallelizable.</li><li>First, and most thoroughly, done by Endo, Taura, and Yonezawa (SC97, 64 processor machine).</li><li>Our distribution contains simpler version ...</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å¹¶è¡Œæ ‡è®°å’Œå¤„ç†å™¨">å¹¶è¡Œæ ‡è®°å’Œå¤„ç†å™¨<a class="hash-link" href="#å¹¶è¡Œæ ‡è®°å’Œå¤„ç†å™¨" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>éšç€å®¢æˆ·ç«¯å¹¶è¡Œåº¦çš„å¢åŠ ï¼Œæœ€ç»ˆæˆ‘ä»¬å°†æ‰€æœ‰æ—¶é—´éƒ½èŠ±åœ¨äº† <code>GC</code> çš„é¡ºåºéƒ¨åˆ†ã€‚</li><li>æ‰«æä¸€æ¬¡å®Œæˆä¸€é¡µå¹¶ä¸”å¯ä»¥å¹¶è¡ŒåŒ–ã€‚æ ‡è®°å‘¢ï¼Ÿ</li><li>æ ‡è®°ä¹Ÿæ˜¯ç›¸å½“å¯å¹¶è¡Œçš„ã€‚</li><li>é¦–å…ˆï¼Œä¹Ÿæ˜¯æœ€å½»åº•çš„ï¼Œç”± <code>Endo</code>ã€<code>Taura</code> å’Œ <code>Yonezawa</code>ï¼ˆ<code>SC97ã€64 processor machine</code>ï¼‰å®Œæˆã€‚</li><li>æˆ‘ä»¬çš„å‘è¡Œç‰ˆåŒ…å«æ›´ç®€å•çš„ç‰ˆæœ¬...</li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="parallel-marking">Parallel marking<a class="hash-link" href="#parallel-marking" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>For n processors, we have n-1 threads waiting to help with next GC.</li><li>Global mark stack becomes queue.</li><li>Each marker thread regularly:<ul><li>Removes a few entries from queue tail.</li><li>Marks from those using a local mark stack.</li></ul></li><li>Mark bits are shared between marker threads.<ul><li>Either use mark bytes, or atomic-compare-and-swap.<ul><li>Mark bytes usually win. (1/8 - 1/16 memory overhead.)</li></ul></li><li>Work may be duplicated but rarely is.</li></ul></li><li>Load balance by returning part of local stack to top of queue<ul><li>When local mark stack overflows.</li><li>When it notices empty global queue.</li></ul></li><li>Seems to scale adequately, at least for small SMPs.<ul><li>Limit appears to be bus bandwidth.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å¹¶è¡Œæ ‡è®°">å¹¶è¡Œæ ‡è®°<a class="hash-link" href="#å¹¶è¡Œæ ‡è®°" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>å¯¹äº <code>n</code> ä¸ªå¤„ç†å™¨ï¼Œæˆ‘ä»¬æœ‰ <code>n-1</code> ä¸ªçº¿ç¨‹ç­‰å¾…å¸®åŠ©ä¸‹ä¸€æ¬¡ <code>GC</code>ã€‚</li><li>å…¨å±€æ ‡è®°æ ˆå˜æˆé˜Ÿåˆ—ã€‚</li><li>æ¯ä¸ªæ ‡è®°çº¿ç¨‹å®šæœŸï¼š<ul><li>ä»é˜Ÿåˆ—å°¾éƒ¨åˆ é™¤ä¸€äº›æ¡ç›®ã€‚</li><li>ä½¿ç”¨æœ¬åœ°æ ‡è®°å †æ ˆçš„æ ‡è®°ã€‚</li></ul></li><li>æ ‡è®°ä½åœ¨æ ‡è®°çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚<ul><li>è¦ä¹ˆä½¿ç”¨æ ‡è®°å­—èŠ‚ï¼Œè¦ä¹ˆä½¿ç”¨åŸå­æ¯”è¾ƒå’Œäº¤æ¢ã€‚<ul><li>æ ‡è®°å­—èŠ‚é€šå¸¸ä¼šè·èƒœã€‚ï¼ˆ1/8 - 1/16 å†…å­˜å¼€é”€ã€‚ï¼‰</li></ul></li><li>å·¥ä½œå¯èƒ½ä¼šé‡å¤ï¼Œä½†å¾ˆå°‘ä¼šé‡å¤ã€‚</li></ul></li><li>é€šè¿‡å°†éƒ¨åˆ†æœ¬åœ°å †æ ˆè¿”å›åˆ°é˜Ÿåˆ—é¡¶éƒ¨æ¥è¿›è¡Œè´Ÿè½½å¹³è¡¡<ul><li>å½“æœ¬åœ°æ ‡è®°å †æ ˆæº¢å‡ºæ—¶ã€‚</li><li>å½“å®ƒæ³¨æ„åˆ°ç©ºçš„å…¨å±€é˜Ÿåˆ—æ—¶ã€‚</li></ul></li><li>ä¼¼ä¹å¯ä»¥å……åˆ†æ‰©å±•ï¼Œè‡³å°‘å¯¹äºå°å‹ <code>SMP</code> è€Œè¨€ã€‚<ul><li>é™åˆ¶ä¼¼ä¹æ˜¯æ€»çº¿å¸¦å®½ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="parallel-marking-data-structure">Parallel marking data structure<a class="hash-link" href="#parallel-marking-data-structure" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200629.png" class="img_PFMr"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="thread-local-allocation-buffers">Thread-local allocation buffers<a class="hash-link" href="#thread-local-allocation-buffers" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Malloc/free implementations acquire and release a lock twice per object
allocation/deallocation:<ul><li>Once per allocation.</li><li>Once per deallocation.</li></ul></li><li>Garbage collectors avoid per-deallocation lock.</li><li>We can also avoid per-allocation lock!</li><li><strong>Use per-thread allocation caches.</strong><ul><li><strong>Each thread allocates a &quot;bunch&quot; of memory.</strong><ul><li><strong>Single lock acquisition.</strong> </li></ul></li><li><strong>Dividing it up doesn&#x27;t require a lock.</strong></li><li><strong>Easy with linear allocation, but also possible here.</strong></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="çº¿ç¨‹å±€éƒ¨åˆ†é…">çº¿ç¨‹å±€éƒ¨åˆ†é…<a class="hash-link" href="#çº¿ç¨‹å±€éƒ¨åˆ†é…" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>Malloc/free å®ç°æ¯æ¬¡å¯¹è±¡åˆ†é…/é‡Šæ”¾ä¸¤æ¬¡è·å–å’Œé‡Šæ”¾é”ï¼š<ul><li>æ¯æ¬¡åˆ†é…ä¸€æ¬¡ã€‚</li><li>æ¯æ¬¡é‡Šæ”¾ä¸€æ¬¡ã€‚</li></ul></li><li>åƒåœ¾æ”¶é›†å™¨é¿å…æ¯æ¬¡é‡Šæ”¾é”ã€‚</li><li>æˆ‘ä»¬è¿˜å¯ä»¥é¿å…æŒ‰åˆ†é…é”ï¼</li><li><strong>ä½¿ç”¨æ¯çº¿ç¨‹åˆ†é…ç¼“å­˜ã€‚</strong><ul><li><strong>æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªâ€œä¸€å †â€å†…å­˜ã€‚</strong><ul><li><strong>å•é”è·å–ã€‚</strong></li></ul></li><li><strong>åˆ†å‰²å®ƒä¸éœ€è¦é”ã€‚</strong></li><li><strong>çº¿æ€§åˆ†é…å¾ˆå®¹æ˜“ï¼Œä½†åœ¨è¿™é‡Œä¹Ÿæ˜¯å¯èƒ½çš„ã€‚</strong></li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="thread-local-allocation-details">Thread-local allocation details<a class="hash-link" href="#thread-local-allocation-details" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Each thread has array of small object free-list headers.</li><li>Each header contains either:<ul><li>Count of allocated objects of that size.</li><li>Pointer to local free list.</li></ul></li><li>To allocate:<ul><li>For small counts, increment count, allocate from global free list.</li><li>For count at threshold, or empty free-list, get a page of objects.</li><li>For nonempty free-list, allocate from local free-list.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="çº¿ç¨‹å±€éƒ¨åˆ†é…ç»†èŠ‚">çº¿ç¨‹å±€éƒ¨åˆ†é…ç»†èŠ‚<a class="hash-link" href="#çº¿ç¨‹å±€éƒ¨åˆ†é…ç»†èŠ‚" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ç»„å°å¯¹è±¡ç©ºé—²åˆ—è¡¨å¤´ã€‚</li><li>æ¯ä¸ªæ ‡å¤´éƒ½åŒ…å«ï¼š<ul><li>è¯¥å¤§å°çš„å·²åˆ†é…å¯¹è±¡çš„è®¡æ•°ã€‚</li><li>æŒ‡å‘æœ¬åœ°ç©ºé—²åˆ—è¡¨çš„æŒ‡é’ˆã€‚</li></ul></li><li>åˆ†é…ï¼š<ul><li>å¯¹äºå°è®¡æ•°ï¼Œå¢åŠ è®¡æ•°ï¼Œä»å…¨å±€ç©ºé—²åˆ—è¡¨ä¸­åˆ†é…ã€‚</li><li>å¯¹äºé˜ˆå€¼è®¡æ•°æˆ–ç©ºç©ºé—²åˆ—è¡¨ï¼Œè·å–å¯¹è±¡é¡µé¢ã€‚</li><li>å¯¹äºéç©ºç©ºé—²åˆ—è¡¨ï¼Œä»æœ¬åœ°ç©ºé—²åˆ—è¡¨ä¸­åˆ†é…ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="finalization">Finalization<a class="hash-link" href="#finalization" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Finalizable objects are added to a growable hash table.</li><li>After each GC, we walk this hash table two or three times:<ul><li>Mark all objects reachable from objects in the table.<ul><li>But not the objects in the table themselves.</li><li>Table entries contain the procedures to do this marking to handle variants
like Java.</li></ul></li><li>Enqueue still unmarked objects in the table for finalization, and possibly
mark them.</li><li>Possibly mark objects reachable from finalizable objects. (Java style
finalization only.)</li></ul></li><li>Process finalizable objects, preferably in separate thread, once allocation
lock is released. (See POPL 2003 paper.)</li><li>Weak pointers (&quot;disappearing links&quot;) are handled similarly.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="ç»ˆç»“">ç»ˆç»“<a class="hash-link" href="#ç»ˆç»“" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>å¯ç»ˆç»“å¯¹è±¡è¢«æ·»åŠ åˆ°å¯å¢é•¿çš„å“ˆå¸Œè¡¨ä¸­ã€‚</li><li>æ¯æ¬¡ <code>GC</code> ä¹‹åï¼Œæˆ‘ä»¬ä¼šéå†è¿™ä¸ªå“ˆå¸Œè¡¨ä¸¤åˆ°ä¸‰éï¼š<ul><li>æ ‡è®°ä»è¡¨ä¸­çš„å¯¹è±¡å¯åˆ°è¾¾çš„æ‰€æœ‰å¯¹è±¡ã€‚<ul><li>ä½†ä¸æ˜¯è¡¨ä¸­çš„å¯¹è±¡æœ¬èº«ã€‚</li><li>è¡¨æ¡ç›®åŒ…å«æ‰§è¡Œæ­¤æ ‡è®°ä»¥å¤„ç† <code>Java</code> ç­‰å˜ä½“çš„è¿‡ç¨‹ã€‚</li></ul></li><li>å°†è¡¨ä¸­ä»æœªæ ‡è®°çš„å¯¹è±¡æ’å…¥é˜Ÿåˆ—ä»¥è¿›è¡Œæœ€ç»ˆç¡®å®šï¼Œå¹¶å¯èƒ½æ ‡è®°å®ƒä»¬ã€‚</li><li>å¯èƒ½æ ‡è®°å¯ä»å¯ç»ˆç»“å¯¹è±¡åˆ°è¾¾çš„å¯¹è±¡ã€‚ï¼ˆä»…é™ <code>Java</code> é£æ ¼çš„æœ€ç»ˆç¡®å®šã€‚ï¼‰</li></ul></li><li>ä¸€æ—¦åˆ†é…é”è¢«é‡Šæ”¾ï¼Œæœ€å¥½åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­å¤„ç†å¯ç»ˆç»“çš„å¯¹è±¡ã€‚ï¼ˆå‚è§ <code>POPL 2003</code> è®ºæ–‡ã€‚ï¼‰</li><li>å¼±æŒ‡é’ˆï¼ˆâ€œæ¶ˆå¤±çš„é“¾æ¥â€ï¼‰çš„å¤„ç†æ–¹å¼ç±»ä¼¼ã€‚</li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="finalization-quick-observations">Finalization (quick observations)<a class="hash-link" href="#finalization-quick-observations" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Finalization is moderately expensive.<ul><li>Extra space overhead.</li><li>Tracing cost is significantly higher, even with Java-style finalization
(factor of 5?)</li></ul></li><li>Clients should avoid registering unnecessary finalizers.
(JVMs can do this statically.)</li><li>Finalizers do not affect performance of the rest of the GC.</li><li>Finalizers must introduce concurrency (even if we had a simple reference
counting collector). There is no such thing as deterministic finalization for
heap objects.<ul><li>Collector runs them in GC_malloc by default. This is a bug except in very
simple cases. Use GC_finalizer_notifier.</li><li>Concurrency is tricky. Be careful.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="ç»ˆç»“å¿«é€Ÿè§‚å¯Ÿ">ç»ˆç»“(å¿«é€Ÿè§‚å¯Ÿ)<a class="hash-link" href="#ç»ˆç»“å¿«é€Ÿè§‚å¯Ÿ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>æœ€ç»ˆç¡®å®šçš„æˆæœ¬é€‚ä¸­ã€‚<ul><li>é¢å¤–çš„ç©ºé—´å¼€é”€ã€‚</li><li>è·Ÿè¸ªæˆæœ¬æ˜æ˜¾æ›´é«˜ï¼Œå³ä½¿ä½¿ç”¨ <code>Java</code> é£æ ¼çš„ç»ˆç»“ï¼ˆ5 å€ï¼Ÿï¼‰</li></ul></li><li>å®¢æˆ·ç«¯åº”é¿å…æ³¨å†Œä¸å¿…è¦çš„ç»ˆç»“å™¨ã€‚ï¼ˆ<code>JVM</code> å¯ä»¥é™æ€åœ°æ‰§è¡Œæ­¤æ“ä½œã€‚ï¼‰</li><li>ç»ˆç»“å™¨ä¸ä¼šå½±å“ <code>GC</code> å…¶ä½™éƒ¨åˆ†çš„æ€§èƒ½ã€‚</li><li>ç»ˆç»“å™¨å¿…é¡»å¼•å…¥å¹¶å‘æ€§ï¼ˆå³ä½¿æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„å¼•ç”¨è®¡æ•°æ”¶é›†å™¨ï¼‰ã€‚å †å¯¹è±¡æ²¡æœ‰ç¡®å®šæ€§ç»ˆç»“ä¹‹ç±»çš„ä¸œè¥¿ã€‚<ul><li>æ”¶é›†å™¨é»˜è®¤åœ¨ <code>GC_malloc</code> ä¸­è¿è¡Œå®ƒä»¬ã€‚é™¤äº†éå¸¸ç®€å•çš„æƒ…å†µå¤–ï¼Œè¿™æ˜¯ä¸€ä¸ªé”™è¯¯ã€‚ä½¿ç”¨ <code>GC_finalizer_notifier</code>ã€‚</li><li>å¹¶å‘æ˜¯æ£˜æ‰‹çš„ã€‚å½“å¿ƒã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="debugging-support">Debugging support<a class="hash-link" href="#debugging-support" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li><p>Debug allocators &quot;wrap&quot; each object with extra information:</p><ul><li>Source file, line number of allocation site.</li><li>Possibly a stack trace for allocation site.</li><li>Space for a back pointer. (Should be elsewhere...)</li><li>Requested object size.</li><li>Magic (address dependent) numbers before and after object.</li></ul></li><li><p>Can mostly tolerate a mixture of wrapped and unwrapped objects.</p><ul><li>Relies on &quot;magic numbers&quot;.</li><li>May lead to extra error reports.</li></ul></li><li><p>è°ƒè¯•åˆ†é…å™¨ç”¨é¢å¤–çš„ä¿¡æ¯â€œåŒ…è£…â€æ¯ä¸ªå¯¹è±¡ï¼š</p><ul><li>æºæ–‡ä»¶ï¼Œåˆ†é…ç«™ç‚¹çš„è¡Œå·ã€‚</li><li>å¯èƒ½æ˜¯åˆ†é…ç«™ç‚¹çš„å †æ ˆè·Ÿè¸ªã€‚</li><li>åå‘æŒ‡é’ˆçš„ç©ºé—´ã€‚ï¼ˆåº”è¯¥åœ¨åˆ«å¤„â€¦â€¦ï¼‰</li><li>è¯·æ±‚çš„å¯¹è±¡å¤§å°ã€‚</li><li>å¯¹è±¡å‰åçš„é­”æœ¯ï¼ˆåœ°å€ç›¸å…³ï¼‰æ•°å­—ã€‚</li></ul></li><li><p>å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥å®¹å¿åŒ…è£¹å’ŒæœªåŒ…è£¹ç‰©ä½“çš„æ··åˆã€‚</p><ul><li>ä¾é â€œå¹»æ•°â€ã€‚</li><li>å¯èƒ½å¯¼è‡´é¢å¤–çš„é”™è¯¯æŠ¥å‘Šã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="debugging-facilities">Debugging facilities<a class="hash-link" href="#debugging-facilities" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>GC can check for overwrite errors.</li><li>Various error checks in GC_debug routines.</li><li>Can be configured for leak detection.</li><li>Can tell you whether a single misidentified pointer might result in unbounded
space leak (See POPL 2002)</li><li>Can give back-traces of random heap samples (requires different build flags):<div class="codeBlockContainer_CBWl language-log theme-code-block"><div class="codeBlockContent_vhl8" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-log codeBlock_w2AC thin-scrollbar"><code class="codeBlockLines_OfWd"><span class="token-line" style="color:#393A34"><span class="token plain">  ****Chose address 0x81ac567 in object 0x81ac568 (trace_test.c:13, sz=8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PTRFREE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Reachable via 0 levels of pointers from offset 4 in object:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x8192090 (trace_test.c:11, sz=8, NORMAL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Reachable via 1 levels of pointers from offset 0 in object:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x81920b8 (trace_test.c:11, sz=8, NORMAL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Reachable via 2 levels of pointers from root at 0x8055bd4</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="copyButton_R7VQ clean-btn"><span class="copyButtonIcons_Uqyx" aria-hidden="true"><svg class="copyButtonIcon_CtfL" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Mq1p" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="è°ƒè¯•è®¾æ–½">è°ƒè¯•è®¾æ–½<a class="hash-link" href="#è°ƒè¯•è®¾æ–½" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li><code>GC</code> å¯ä»¥æ£€æŸ¥è¦†ç›–é”™è¯¯ã€‚</li><li><code>GC_debug</code> ä¾‹ç¨‹ä¸­çš„å„ç§é”™è¯¯æ£€æŸ¥ã€‚</li><li>å¯é…ç½®ç”¨äºæ³„æ¼æ£€æµ‹ã€‚</li><li>å¯ä»¥å‘Šè¯‰æ‚¨å•ä¸ªé”™è¯¯è¯†åˆ«çš„æŒ‡é’ˆæ˜¯å¦å¯èƒ½å¯¼è‡´æ— é™ç©ºé—´æ³„æ¼ï¼ˆå‚è§ <code>POPL 2002</code>ï¼‰</li><li>å¯ä»¥æä¾›éšæœºå †æ ·æœ¬çš„å›æº¯ï¼ˆéœ€è¦ä¸åŒçš„æ„å»ºæ ‡å¿—ï¼‰ï¼š</li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="current-state">Current state<a class="hash-link" href="#current-state" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Easily available (google &quot;garbage collector&quot;)</li><li>Supports Linux, Unix variants, Windows, MacOSX,</li><li>Used in a variety of C/C++ systems<ul><li>w3m, vesta, ...</li><li>High end Xerox printers.</li><li>Sometimes as leak detector (e.g Mozilla).</li><li>Usually with little type information.</li></ul></li><li>Used in many language runtimes:<ul><li>Gcj (gcc), Mono, Bigloo Scheme</li><li>Usually with heap type information.</li><li>Information on static data (e.g. 4.5MB for gcj) would be easy and useful.</li></ul></li><li><strong>Current version 6.3; 6.4 should appear shortly.</strong></li><li><strong>Stay tuned for 7.0alpha1 (cleaner code base, ...)</strong></li></ul><ul><li>å®¹æ˜“è·å¾—ï¼ˆç™¾åº¦ä¸€ä¸‹â€œåƒåœ¾æ”¶é›†å™¨â€ï¼‰</li><li>æ”¯æŒ <code>Linux</code>ã€<code>Unix</code> å˜ä½“ã€<code>Windows</code>ã€<code>MacOSX</code>ã€</li><li>ç”¨äºå„ç§ <code>C/C++</code> ç³»ç»Ÿ<ul><li><code>w3m</code>, <code>vesta</code>, ...</li><li>é«˜ç«¯æ–½ä¹æ‰“å°æœºã€‚</li><li>æœ‰æ—¶ç”¨ä½œæ£€æ¼ä»ªï¼ˆä¾‹å¦‚ <code>Mozilla</code>ï¼‰ã€‚</li><li>é€šå¸¸åªæœ‰å¾ˆå°‘çš„ç±»å‹ä¿¡æ¯ã€‚</li></ul></li><li>åœ¨è®¸å¤šè¯­è¨€è¿è¡Œæ—¶ä¸­ä½¿ç”¨ï¼š<ul><li><code>Gcj (gcc)</code>ã€<code>Mono</code>ã€<code>Bigloo</code> æ–¹æ¡ˆ</li><li>é€šå¸¸å¸¦æœ‰å †ç±»å‹ä¿¡æ¯ã€‚</li><li>æœ‰å…³é™æ€æ•°æ®çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œ<code>gcj</code> ä¸º <code>4.5MB</code>ï¼‰å°†æ˜¯ç®€å•è€Œæœ‰ç”¨çš„ã€‚</li></ul></li><li><strong>å½“å‰ç‰ˆæœ¬ <code>6.3</code>ï¼›<code>6.4</code> åº”è¯¥å¾ˆå¿«å°±ä¼šå‡ºç°ã€‚</strong></li><li><strong>è¯·ç»§ç»­å…³æ³¨ <code>7.0alpha1</code>ï¼ˆæ›´ç®€æ´çš„ä»£ç åº“ï¼Œ...ï¼‰</strong></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="performance-characteristics">Performance characteristics<a class="hash-link" href="#performance-characteristics" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>We use GCBench here.<ul><li>More of a sanity check than a benchmark. </li><li>Allocates complete binary trees of varying depths.</li><li>Depth n -&gt; 2 n - 1 nodes of 2 pointers + 2 ints</li><li>Translated to multiple source languages.</li><li>Can see effect of object lifetime. </li><li>About as realistic as any toy benchmark (not very)</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="æ€§èƒ½ç‰¹ç‚¹">æ€§èƒ½ç‰¹ç‚¹<a class="hash-link" href="#æ€§èƒ½ç‰¹ç‚¹" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ <code>GCBench</code>ã€‚<ul><li>ä¸å…¶è¯´æ˜¯åŸºå‡†ï¼Œä¸å¦‚è¯´æ˜¯å¥å…¨æ€§æ£€æŸ¥ã€‚</li><li>åˆ†é…ä¸åŒæ·±åº¦çš„å®Œæ•´äºŒå‰æ ‘ã€‚</li><li>æ·±åº¦ n -&gt; 2 n - 2 ä¸ªæŒ‡é’ˆçš„ 1 ä¸ªèŠ‚ç‚¹ + 2 ä¸ªæ•´æ•°</li><li>ç¿»è¯‘æˆå¤šç§æºè¯­è¨€ã€‚</li><li>å¯ä»¥çœ‹åˆ°å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„å½±å“ã€‚</li><li>ä¸ä»»ä½•ç©å…·åŸºå‡†ä¸€æ ·é€¼çœŸï¼ˆä¸æ˜¯éå¸¸ï¼‰</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="gcbench-vs-hotspot-142-client">GCBench vs HotSpot 1.4.2 client<a class="hash-link" href="#gcbench-vs-hotspot-142-client" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200803.png" class="img_PFMr"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="cc-gcbench-comparison">C/C++ GCBench Comparison<a class="hash-link" href="#cc-gcbench-comparison" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Compare:<ul><li>C with malloc/free<ul><li>&quot;Pause&quot; is tree deallocation time (predictable).</li></ul></li><li>Boost classic reference counting (simple and tuned version)<ul><li>&quot;Pause&quot; is recursive deallocation time during assignment(unpredictable).</li></ul></li><li>Boost versions use C++ benchmark.</li><li>Expl. free and BDW GC use C version.</li><li>HotSpot uses Java version.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="cc-gcbench-æ¯”è¾ƒ">C/C++ <code>GCBench</code> æ¯”è¾ƒ<a class="hash-link" href="#cc-gcbench-æ¯”è¾ƒ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>æ¯”è¾ƒï¼š<ul><li><code>C</code> å¸¦ <code>malloc/free</code><ul><li>â€œæš‚åœâ€æ˜¯æ ‘é‡Šæ”¾æ—¶é—´ï¼ˆå¯é¢„æµ‹ï¼‰ã€‚</li></ul></li><li>æå‡ç»å…¸å¼•ç”¨è®¡æ•°ï¼ˆç®€å•å’Œè°ƒæ•´çš„ç‰ˆæœ¬ï¼‰<ul><li>â€œæš‚åœâ€æ˜¯åˆ†é…æœŸé—´çš„é€’å½’é‡Šæ”¾æ—¶é—´ï¼ˆä¸å¯é¢„æµ‹ï¼‰ã€‚</li></ul></li><li><code>Boost</code> ç‰ˆæœ¬ä½¿ç”¨ <code>C++</code> åŸºå‡†æµ‹è¯•ã€‚</li><li>è§£é‡Šã€‚<code>free</code> å’Œ <code>BDW GC</code> ä½¿ç”¨ <code>C</code> ç‰ˆæœ¬ã€‚</li><li><code>HotSpot</code> ä½¿ç”¨ <code>Java</code> ç‰ˆæœ¬ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="execution-time-msecs-2ghz-xeon-vs-alternatives">Execution time (msecs, 2GHz Xeon) vs. alternatives<a class="hash-link" href="#execution-time-msecs-2ghz-xeon-vs-alternatives" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200836.png" class="img_PFMr"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="max-space-usage-mb-vs-others">Max. space usage (MB) vs. others<a class="hash-link" href="#max-space-usage-mb-vs-others" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200856.png" class="img_PFMr"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="max-pause-time-msecs-vs-others">Max pause time (msecs) vs. others<a class="hash-link" href="#max-pause-time-msecs-vs-others" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200917.png" class="img_PFMr"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="but">But:<a class="hash-link" href="#but" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>GCBench uses small objects.</li><li>Allocation + GC cost is proportional to object size.</li><li><strong>Redo experiment with 128 extra null pointer per node.</strong></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="ä½†æ˜¯">ä½†æ˜¯<a class="hash-link" href="#ä½†æ˜¯" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li><code>GCBench</code> ä½¿ç”¨å°å¯¹è±¡ã€‚</li><li>åˆ†é… + <code>GC</code> æˆæœ¬ä¸å¯¹è±¡å¤§å°æˆæ­£æ¯”ã€‚</li><li><strong>é‡åšå®éªŒï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰ 128 ä¸ªé¢å¤–çš„ç©ºæŒ‡é’ˆã€‚</strong></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="large-objectsmsecs-mb-2ghz-xeon">Large objects(msecs, MB, 2GHz Xeon)<a class="hash-link" href="#large-objectsmsecs-mb-2ghz-xeon" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409200955.png" class="img_PFMr"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="large-objectsthread-safe">Large objects(thread-safe)<a class="hash-link" href="#large-objectsthread-safe" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409201050.png" class="img_PFMr"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="some-older-measurements-on-malloc-benchmarks">Some older measurements on malloc benchmarks<a class="hash-link" href="#some-older-measurements-on-malloc-benchmarks" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>These are a bit obsolete, things have probably improved, but ...</li><li>Measured on 4xPPro (which was obsolete then).</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="mallocåŸºå‡†ä¸Šçš„ä¸€äº›æ—§æµ‹é‡"><code>malloc</code>åŸºå‡†ä¸Šçš„ä¸€äº›æ—§æµ‹é‡<a class="hash-link" href="#mallocåŸºå‡†ä¸Šçš„ä¸€äº›æ—§æµ‹é‡" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>è¿™äº›æœ‰ç‚¹è¿‡æ—¶äº†ï¼Œæƒ…å†µå¯èƒ½æœ‰æ‰€æ”¹å–„ï¼Œä½†æ˜¯...</li><li>åœ¨ <code>4xPPro</code>ï¼ˆå½“æ—¶å·²ç»è¿‡æ—¶ï¼‰ä¸Šæµ‹é‡ã€‚</li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="ghostscript-throughput">Ghostscript throughput<a class="hash-link" href="#ghostscript-throughput" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409201114.png" class="img_PFMr"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="mt_gcbench2-throughput">MT_GCBench2 throughput<a class="hash-link" href="#mt_gcbench2-throughput" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409201152.png" class="img_PFMr"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="larson-slightly-mod-benchmark-throughput">Larson (slightly mod.) benchmark throughput<a class="hash-link" href="#larson-slightly-mod-benchmark-throughput" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409201215.png" class="img_PFMr"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="larson-small-throughput">Larson-small throughput<a class="hash-link" href="#larson-small-throughput" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><img loading="lazy" src="https://raw.githubusercontent.com/danyow/picgo/main/20220409201301.png" class="img_PFMr"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="other-experiences">Other experiences<a class="hash-link" href="#other-experiences" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Generally works quite well for small (&lt; 100MB live data)
clients or on 64-bit machines.<ul><li>Sometimes needs a bit pointer location information for frequently occurring
heap objects. Usually GC_MALLOC_ATOMIC is sufficient for C code.</li></ul></li><li>Some successful uses with much larger heaps.</li><li>Some problems with 500MB heaps on 32-bit machines.</li><li>Large arrays (&gt; about 1MB) sometimes problematic.</li><li>Fragmentation cost (for heaps &gt; a few MB) is typically less than a factor of
2.<ul><li>Fragmentation essentially never an issue for small objects.</li><li>Whole block coalescing is important.</li></ul></li><li>I haven&#x27;t seen much of a problem with long running apps.
(Vesta, Xerox printers).</li><li>Stationary objects allow one word object headers in gcj.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="å…¶ä»–ç»éªŒ">å…¶ä»–ç»éªŒ<a class="hash-link" href="#å…¶ä»–ç»éªŒ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>é€šå¸¸é€‚ç”¨äºå°å‹ï¼ˆ&lt; <code>100MB</code> å®æ—¶æ•°æ®ï¼‰å®¢æˆ·ç«¯æˆ– 64 ä½æœºå™¨ã€‚<ul><li>æœ‰æ—¶éœ€è¦é¢‘ç¹å‡ºç°çš„å †å¯¹è±¡çš„ä½æŒ‡é’ˆä½ç½®ä¿¡æ¯ã€‚é€šå¸¸ <code>GC_MALLOC_ATOMIC</code> å¯¹äº C ä»£ç å°±è¶³å¤Ÿäº†ã€‚</li></ul></li><li>ä¸€äº›æˆåŠŸçš„ä½¿ç”¨æ›´å¤§çš„å †ã€‚</li><li>32 ä½æœºå™¨ä¸Š <code>500MB</code> å †çš„ä¸€äº›é—®é¢˜ã€‚</li><li>å¤§å‹æ•°ç»„ï¼ˆ&gt; å¤§çº¦ <code>1MB</code>ï¼‰æœ‰æ—¶ä¼šå‡ºç°é—®é¢˜ã€‚</li><li>ç¢ç‰‡æˆæœ¬ï¼ˆå¯¹äº &gt; å‡  <code>MB</code> çš„å †ï¼‰é€šå¸¸å°äº 2 å€ã€‚<ul><li>å¯¹äºå°ç‰©ä½“æ¥è¯´ï¼Œç¢ç‰‡åŒ–åŸºæœ¬ä¸Šä¸æ˜¯é—®é¢˜ã€‚</li><li>æ•´ä¸ªå—åˆå¹¶å¾ˆé‡è¦ã€‚</li></ul></li><li>æˆ‘æ²¡æœ‰çœ‹åˆ°é•¿æ—¶é—´è¿è¡Œçš„åº”ç”¨ç¨‹åºæœ‰ä»€ä¹ˆé—®é¢˜ã€‚ï¼ˆ<code>Vesta</code>ï¼Œ<code>Xerox printers</code>ï¼‰ã€‚</li><li>å›ºå®šå¯¹è±¡å…è®¸åœ¨ <code>gcj</code> ä¸­ä½¿ç”¨ä¸€ä¸ªå•è¯å¯¹è±¡æ ‡é¢˜ã€‚</li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="space-overhead-of-conservative-gc">Space overhead of conservative GC<a class="hash-link" href="#space-overhead-of-conservative-gc" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Clever empirical study:<ul><li>Hirzel, Diwan, Henkel, &quot;On the Usefulness of Type and Liveness Accuracy for
Garbage Collection&quot;, TOPLAS 24, 6, November 2002.<ul><li>Liveness information is usually more important than type information,
especially on 64-bit platforms.</li><li>Up to 62% space overhead.</li></ul></li></ul></li><li>More theoretical study:<ul><li>Boehm, &quot;Bounding Space Usage of Conservative Garbage Collectors&quot;, POPL 2002.</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="ä¿å®ˆgcçš„ç©ºé—´å¼€é”€">ä¿å®ˆ<code>GC</code>çš„ç©ºé—´å¼€é”€<a class="hash-link" href="#ä¿å®ˆgcçš„ç©ºé—´å¼€é”€" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>å·§å¦™çš„å®è¯ç ”ç©¶ï¼š<ul><li><code>Hirzel</code>, <code>Diwan</code>, <code>Henkel</code>ï¼Œâ€œå…³äºåƒåœ¾æ”¶é›†çš„ç±»å‹å’Œæ´»æ€§å‡†ç¡®æ€§çš„æœ‰ç”¨æ€§â€ï¼Œ<code>TOPLAS 24, 6, November 2002</code>ã€‚<ul><li>æ´»æ€§ä¿¡æ¯é€šå¸¸æ¯”ç±»å‹ä¿¡æ¯æ›´é‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨ 64 ä½å¹³å°ä¸Šã€‚</li><li>é«˜è¾¾ 62% çš„ç©ºé—´å¼€é”€ã€‚</li></ul></li></ul></li><li>æ›´å¤šç†è®ºç ”ç©¶ï¼š<ul><li><code>Boehm</code>ï¼Œâ€œä¿å®ˆåƒåœ¾æ”¶é›†å™¨çš„è¾¹ç•Œç©ºé—´ä½¿ç”¨â€ï¼Œ<code>POPL 2002</code>ã€‚</li></ul></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="conclusions">Conclusions<a class="hash-link" href="#conclusions" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><ul><li>Collector is still a useful tool for<ul><li>Avoiding manual memory management issues in C/C++.</li><li>Quickly building language runtimes, especially, but not only, for research
systems.</li><li>Some GC research. (One underlying algorithm, mult. languages.)</li></ul></li><li>Performance is competitive with malloc/free.<ul><li>Usually wins for threads + small objects.</li></ul></li><li>Tracing performance is very close to best commercial JVMs.<ul><li>See also Smith and Morrisett, ISMM 98.</li><li>Currently does less well when there is a large benefit from generational
GC. (But see OOPSLA 2003 paper by Barabash et al.)</li></ul></li><li>There may be a cache cost to free list allocation.<ul><li>See work by Blackburn, Cheng, and McKinley.</li><li>But I don&#x27;t think we fully understand this yet...</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_c5FC" id="ç»“è®º">ç»“è®º<a class="hash-link" href="#ç»“è®º" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li>æ”¶é›†å™¨ä»ç„¶æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„å·¥å…·<ul><li>é¿å… <code>C/C++</code> ä¸­çš„æ‰‹åŠ¨å†…å­˜ç®¡ç†é—®é¢˜ã€‚</li><li>å¿«é€Ÿæ„å»ºè¯­è¨€è¿è¡Œæ—¶ï¼Œå°¤å…¶æ˜¯ä½†ä¸ä»…é™äºç ”ç©¶ç³»ç»Ÿã€‚</li><li>ä¸€äº› <code>GC</code> ç ”ç©¶ã€‚ï¼ˆä¸€ç§åº•å±‚ç®—æ³•ï¼Œå¤šç§è¯­è¨€ã€‚ï¼‰</li></ul></li><li>æ€§èƒ½ä¸ <code>malloc/free</code> å…·æœ‰ç«äº‰åŠ›ã€‚<ul><li>é€šå¸¸èµ¢å¾—çº¿ç¨‹+å°å¯¹è±¡ã€‚</li></ul></li><li>è·Ÿè¸ªæ€§èƒ½éå¸¸æ¥è¿‘æœ€å¥½çš„å•†ä¸š <code>JVM</code>ã€‚<ul><li>å¦è§ <code>Smith</code> å’Œ <code>Morrisettï¼ŒISMM 98</code>ã€‚</li><li>å½“åˆ†ä»£ <code>GC</code> æœ‰å¾ˆå¤§çš„å¥½å¤„æ—¶ï¼Œç›®å‰åšå¾—ä¸å¤ªå¥½ã€‚ï¼ˆä½†è¯·å‚é˜… <code>Barabash</code> ç­‰äººçš„ <code>OOPSLA 2003</code> è®ºæ–‡ã€‚ï¼‰</li></ul></li><li>ç©ºé—²åˆ—è¡¨åˆ†é…å¯èƒ½ä¼šäº§ç”Ÿç¼“å­˜æˆæœ¬ã€‚<ul><li>å‚è§ <code>Blackburn</code>ã€<code>Cheng</code> å’Œ <code>McKinley</code> çš„ä½œå“ã€‚</li><li>ä½†æˆ‘è®¤ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å®Œå…¨ç†è§£è¿™ä¸€ç‚¹......</li></ul></li></ul><hr></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://crowdin.com/project/docusaurus-v2/zh-Hans" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_OMbO" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>ç¼–è¾‘æ­¤é¡µ</a></div><div class="col lastUpdated_vA0S"><span class="theme-last-updated">æœ€å<!-- -->ç”± <b>danyow</b> <!-- -->äº <b><time datetime="2022-04-10T02:13:31.000Z">2022/4/10</time></b> <!-- -->æ›´æ–°</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="æ–‡æ¡£åˆ†é¡µå¯¼èˆª"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/translation"><div class="pagination-nav__sublabel">ä¸Šä¸€é¡µ</div><div class="pagination-nav__label">ç¿»è¯‘</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/translation/luagc"><div class="pagination-nav__sublabel">ä¸‹ä¸€é¡µ</div><div class="pagination-nav__label">Luaçš„åƒåœ¾å›æ”¶</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_jWtb thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#outline" class="table-of-contents__link toc-highlight">Outline</a><ul><li><a href="#æ¦‚è¿°" class="table-of-contents__link toc-highlight">æ¦‚è¿°</a></li></ul></li><li><a href="#what-is-it" class="table-of-contents__link toc-highlight">What is it?</a><ul><li><a href="#ä»–æ˜¯ä»€ä¹ˆ" class="table-of-contents__link toc-highlight">ä»–æ˜¯ä»€ä¹ˆï¼Ÿ</a></li></ul></li><li><a href="#example-lisp-s-expressions" class="table-of-contents__link toc-highlight">Example: Lisp S-expressions</a><ul><li><a href="#ç¤ºä¾‹lisp-s-expressions" class="table-of-contents__link toc-highlight">ç¤ºä¾‹ï¼š<code>Lisp S-expressions</code></a></li></ul></li><li><a href="#where-did-it-come-from" class="table-of-contents__link toc-highlight">Where did it come from?</a><ul><li><a href="#å®ƒæ˜¯ä»å“ªé‡Œæ¥çš„" class="table-of-contents__link toc-highlight">å®ƒæ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ</a></li></ul></li><li><a href="#what-else-can-it-do" class="table-of-contents__link toc-highlight">What else can it do?</a><ul><li><a href="#å®ƒè¿˜èƒ½åšä»€ä¹ˆ" class="table-of-contents__link toc-highlight">å®ƒè¿˜èƒ½åšä»€ä¹ˆï¼Ÿ</a></li></ul></li><li><a href="#what-cant-it-do" class="table-of-contents__link toc-highlight">What can&#39;t it do?</a><ul><li><a href="#å®ƒä¸èƒ½åšä»€ä¹ˆ" class="table-of-contents__link toc-highlight">å®ƒä¸èƒ½åšä»€ä¹ˆ?</a></li></ul></li><li><a href="#dealing-with-c-conservative-garbage-collection" class="table-of-contents__link toc-highlight">Dealing with C: Conservative Garbage Collection</a><ul><li><a href="#ä¸cæ‰“äº¤é“ä¿å®ˆçš„åƒåœ¾æ”¶é›†" class="table-of-contents__link toc-highlight">ä¸<code>C</code>æ‰“äº¤é“ï¼šä¿å®ˆçš„åƒåœ¾æ”¶é›†</a></li></ul></li><li><a href="#c-interface-overview" class="table-of-contents__link toc-highlight">C Interface overview</a><ul><li><a href="#cæ¥å£æ¦‚è¿°" class="table-of-contents__link toc-highlight"><code>C</code>æ¥å£æ¦‚è¿°</a></li></ul></li><li><a href="#c-interface-main-functions" class="table-of-contents__link toc-highlight">C interface, main functions</a><ul><li><a href="#c-æ¥å£-ä¸»è¦çš„ä¸€äº›æ–¹æ³•" class="table-of-contents__link toc-highlight"><code>C</code> æ¥å£, ä¸»è¦çš„ä¸€äº›æ–¹æ³•:</a></li></ul></li><li><a href="#c-interface" class="table-of-contents__link toc-highlight">C++ interface</a><ul><li><a href="#cæ¥å£" class="table-of-contents__link toc-highlight"><code>C++</code>æ¥å£</a></li></ul></li><li><a href="#environment-variables" class="table-of-contents__link toc-highlight">Environment variables</a><ul><li><a href="#ç¯å¢ƒå˜é‡" class="table-of-contents__link toc-highlight">ç¯å¢ƒå˜é‡</a></li></ul></li><li><a href="#how-does-it-work" class="table-of-contents__link toc-highlight">How does it work?</a><ul><li><a href="#å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„" class="table-of-contents__link toc-highlight">å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</a></li></ul></li><li><a href="#marksweep-illustration" class="table-of-contents__link toc-highlight">Mark/sweep illustration</a><ul><li><a href="#æ ‡è®°æ¸…é™¤-æ’ç”»" class="table-of-contents__link toc-highlight">æ ‡è®°/æ¸…é™¤ æ’ç”»</a></li></ul></li><li><a href="#easy-performance-issue" class="table-of-contents__link toc-highlight">Easy performance issue</a><ul><li><a href="#ç®€å•æ€§èƒ½é—®é¢˜" class="table-of-contents__link toc-highlight">ç®€å•æ€§èƒ½é—®é¢˜</a></li></ul></li><li><a href="#asymptotic-complexity-of-marksweep-vs-copying" class="table-of-contents__link toc-highlight">Asymptotic Complexity of MarkSweep vs. Copying</a><ul><li><a href="#è¿è¡Œæ—¶é—´å¤æ‚åº¦-ms-vs-copyingåˆ†æ" class="table-of-contents__link toc-highlight">è¿è¡Œæ—¶é—´å¤æ‚åº¦ <code>M&amp;S</code> vs <code>Copying</code>åˆ†æ.</a></li></ul></li><li><a href="#implementation-details-overview" class="table-of-contents__link toc-highlight">Implementation details overview</a><ul><li><a href="#å®ç°ç»†èŠ‚æè¿°" class="table-of-contents__link toc-highlight">å®ç°ç»†èŠ‚æè¿°</a></li></ul></li><li><a href="#allocator-design" class="table-of-contents__link toc-highlight">Allocator design</a><ul><li><a href="#åˆ†é…å™¨è®¾è®¡" class="table-of-contents__link toc-highlight">åˆ†é…å™¨è®¾è®¡</a></li></ul></li><li><a href="#heap-layout" class="table-of-contents__link toc-highlight">Heap layout</a><ul><li><a href="#å †å¸ƒå±€" class="table-of-contents__link toc-highlight">å †å¸ƒå±€</a></li></ul></li><li><a href="#meta-data" class="table-of-contents__link toc-highlight">Meta-data</a><ul><li><a href="#å…ƒæ•°æ®" class="table-of-contents__link toc-highlight">å…ƒæ•°æ®</a></li></ul></li><li><a href="#meta-data-lookup" class="table-of-contents__link toc-highlight">Meta-data lookup</a></li><li><a href="#pointer-validity-check" class="table-of-contents__link toc-highlight">Pointer validity check</a><ul><li><a href="#æŒ‡é’ˆæœ‰æ•ˆæ€§æ£€æŸ¥" class="table-of-contents__link toc-highlight">æŒ‡é’ˆæœ‰æ•ˆæ€§æ£€æŸ¥</a></li></ul></li><li><a href="#partial-pointer-location-type-information" class="table-of-contents__link toc-highlight">Partial pointer location (type) information.</a><ul><li><a href="#éƒ¨åˆ†æŒ‡é’ˆä½ç½®ç±»å‹ä¿¡æ¯" class="table-of-contents__link toc-highlight">éƒ¨åˆ†æŒ‡é’ˆä½ç½®ï¼ˆç±»å‹ï¼‰ä¿¡æ¯ã€‚</a></li></ul></li><li><a href="#locating-roots" class="table-of-contents__link toc-highlight">Locating roots</a><ul><li><a href="#å®šä½æ ¹" class="table-of-contents__link toc-highlight">å®šä½æ ¹</a></li></ul></li><li><a href="#basic-mark-algorithm" class="table-of-contents__link toc-highlight">Basic mark algorithm</a><ul><li><a href="#åŸºæœ¬æ ‡è®°ç®—æ³•" class="table-of-contents__link toc-highlight">åŸºæœ¬æ ‡è®°ç®—æ³•</a></li></ul></li><li><a href="#marker-refinements" class="table-of-contents__link toc-highlight">Marker refinements</a><ul><li><a href="#æ ‡è®°æ”¹è¿›" class="table-of-contents__link toc-highlight">æ ‡è®°æ”¹è¿›</a></li></ul></li><li><a href="#the-marker-core-version-pre-70" class="table-of-contents__link toc-highlight">The marker core (version pre-7.0)</a><ul><li><a href="#æ ‡è®°å™¨æ ¸å¿ƒ70ä¹‹å‰çš„ç‰ˆæœ¬" class="table-of-contents__link toc-highlight">æ ‡è®°å™¨æ ¸å¿ƒï¼ˆ7.0ä¹‹å‰çš„ç‰ˆæœ¬ï¼‰</a></li></ul></li><li><a href="#marker-performance-why-gc-needs-a-fast-multiplier" class="table-of-contents__link toc-highlight">Marker performance: Why GC needs a fast multiplier.</a><ul><li><a href="#æ ‡è®°å™¨æ€§èƒ½ä¸ºä»€ä¹ˆ-gc-éœ€è¦å¿«é€Ÿä¹˜æ³•å™¨" class="table-of-contents__link toc-highlight">æ ‡è®°å™¨æ€§èƒ½ï¼šä¸ºä»€ä¹ˆ <code>GC</code> éœ€è¦å¿«é€Ÿä¹˜æ³•å™¨</a></li></ul></li><li><a href="#what-if-the-mark-stack-overflows" class="table-of-contents__link toc-highlight">What if the mark stack overflows?</a><ul><li><a href="#å¦‚æœæ ‡è®°å †æ ˆæº¢å‡º" class="table-of-contents__link toc-highlight">å¦‚æœæ ‡è®°å †æ ˆæº¢å‡º</a></li></ul></li><li><a href="#the-sweep-phase" class="table-of-contents__link toc-highlight">The &quot;sweep phase&quot;</a><ul><li><a href="#æ¸…é™¤é˜¶æ®µ" class="table-of-contents__link toc-highlight">æ¸…é™¤é˜¶æ®µ</a></li></ul></li><li><a href="#thread-support" class="table-of-contents__link toc-highlight">Thread support</a><ul><li><a href="#çº¿ç¨‹æ”¯æŒ" class="table-of-contents__link toc-highlight">çº¿ç¨‹æ”¯æŒ</a></li></ul></li><li><a href="#enhancement-1-black-listing" class="table-of-contents__link toc-highlight">Enhancement 1: Black-listing</a></li><li><a href="#black-listing-contd" class="table-of-contents__link toc-highlight">Black-listing (contd.)</a><ul><li><a href="#é»‘åå•-ç»­" class="table-of-contents__link toc-highlight">é»‘åå• (ç»­)</a></li></ul></li><li><a href="#optional-enhancements" class="table-of-contents__link toc-highlight">Optional enhancements</a><ul><li><a href="#å¯é€‰å¢å¼ºåŠŸèƒ½" class="table-of-contents__link toc-highlight">å¯é€‰å¢å¼ºåŠŸèƒ½</a></li></ul></li><li><a href="#generational-incremental-mostly-concurrent-gc" class="table-of-contents__link toc-highlight">Generational, Incremental, Mostly Concurrent GC</a><ul><li><a href="#åˆ†ä»£å¢é‡å¤§éƒ¨åˆ†å¹¶å‘" class="table-of-contents__link toc-highlight">åˆ†ä»£ã€å¢é‡ã€å¤§éƒ¨åˆ†å¹¶å‘</a></li></ul></li><li><a href="#parallel-marking--processor-scalability" class="table-of-contents__link toc-highlight">Parallel marking &amp; processor scalability</a><ul><li><a href="#å¹¶è¡Œæ ‡è®°å’Œå¤„ç†å™¨" class="table-of-contents__link toc-highlight">å¹¶è¡Œæ ‡è®°å’Œå¤„ç†å™¨</a></li></ul></li><li><a href="#parallel-marking" class="table-of-contents__link toc-highlight">Parallel marking</a><ul><li><a href="#å¹¶è¡Œæ ‡è®°" class="table-of-contents__link toc-highlight">å¹¶è¡Œæ ‡è®°</a></li></ul></li><li><a href="#parallel-marking-data-structure" class="table-of-contents__link toc-highlight">Parallel marking data structure</a></li><li><a href="#thread-local-allocation-buffers" class="table-of-contents__link toc-highlight">Thread-local allocation buffers</a><ul><li><a href="#çº¿ç¨‹å±€éƒ¨åˆ†é…" class="table-of-contents__link toc-highlight">çº¿ç¨‹å±€éƒ¨åˆ†é…</a></li></ul></li><li><a href="#thread-local-allocation-details" class="table-of-contents__link toc-highlight">Thread-local allocation details</a><ul><li><a href="#çº¿ç¨‹å±€éƒ¨åˆ†é…ç»†èŠ‚" class="table-of-contents__link toc-highlight">çº¿ç¨‹å±€éƒ¨åˆ†é…ç»†èŠ‚</a></li></ul></li><li><a href="#finalization" class="table-of-contents__link toc-highlight">Finalization</a><ul><li><a href="#ç»ˆç»“" class="table-of-contents__link toc-highlight">ç»ˆç»“</a></li></ul></li><li><a href="#finalization-quick-observations" class="table-of-contents__link toc-highlight">Finalization (quick observations)</a><ul><li><a href="#ç»ˆç»“å¿«é€Ÿè§‚å¯Ÿ" class="table-of-contents__link toc-highlight">ç»ˆç»“(å¿«é€Ÿè§‚å¯Ÿ)</a></li></ul></li><li><a href="#debugging-support" class="table-of-contents__link toc-highlight">Debugging support</a></li><li><a href="#debugging-facilities" class="table-of-contents__link toc-highlight">Debugging facilities</a><ul><li><a href="#è°ƒè¯•è®¾æ–½" class="table-of-contents__link toc-highlight">è°ƒè¯•è®¾æ–½</a></li></ul></li><li><a href="#current-state" class="table-of-contents__link toc-highlight">Current state</a></li><li><a href="#performance-characteristics" class="table-of-contents__link toc-highlight">Performance characteristics</a><ul><li><a href="#æ€§èƒ½ç‰¹ç‚¹" class="table-of-contents__link toc-highlight">æ€§èƒ½ç‰¹ç‚¹</a></li></ul></li><li><a href="#gcbench-vs-hotspot-142-client" class="table-of-contents__link toc-highlight">GCBench vs HotSpot 1.4.2 client</a></li><li><a href="#cc-gcbench-comparison" class="table-of-contents__link toc-highlight">C/C++ GCBench Comparison</a><ul><li><a href="#cc-gcbench-æ¯”è¾ƒ" class="table-of-contents__link toc-highlight">C/C++ <code>GCBench</code> æ¯”è¾ƒ</a></li></ul></li><li><a href="#execution-time-msecs-2ghz-xeon-vs-alternatives" class="table-of-contents__link toc-highlight">Execution time (msecs, 2GHz Xeon) vs. alternatives</a></li><li><a href="#max-space-usage-mb-vs-others" class="table-of-contents__link toc-highlight">Max. space usage (MB) vs. others</a></li><li><a href="#max-pause-time-msecs-vs-others" class="table-of-contents__link toc-highlight">Max pause time (msecs) vs. others</a></li><li><a href="#but" class="table-of-contents__link toc-highlight">But:</a><ul><li><a href="#ä½†æ˜¯" class="table-of-contents__link toc-highlight">ä½†æ˜¯</a></li></ul></li><li><a href="#large-objectsmsecs-mb-2ghz-xeon" class="table-of-contents__link toc-highlight">Large objects(msecs, MB, 2GHz Xeon)</a></li><li><a href="#large-objectsthread-safe" class="table-of-contents__link toc-highlight">Large objects(thread-safe)</a></li><li><a href="#some-older-measurements-on-malloc-benchmarks" class="table-of-contents__link toc-highlight">Some older measurements on malloc benchmarks</a><ul><li><a href="#mallocåŸºå‡†ä¸Šçš„ä¸€äº›æ—§æµ‹é‡" class="table-of-contents__link toc-highlight"><code>malloc</code>åŸºå‡†ä¸Šçš„ä¸€äº›æ—§æµ‹é‡</a></li></ul></li><li><a href="#ghostscript-throughput" class="table-of-contents__link toc-highlight">Ghostscript throughput</a></li><li><a href="#mt_gcbench2-throughput" class="table-of-contents__link toc-highlight">MT_GCBench2 throughput</a></li><li><a href="#larson-slightly-mod-benchmark-throughput" class="table-of-contents__link toc-highlight">Larson (slightly mod.) benchmark throughput</a></li><li><a href="#larson-small-throughput" class="table-of-contents__link toc-highlight">Larson-small throughput</a></li><li><a href="#other-experiences" class="table-of-contents__link toc-highlight">Other experiences</a><ul><li><a href="#å…¶ä»–ç»éªŒ" class="table-of-contents__link toc-highlight">å…¶ä»–ç»éªŒ</a></li></ul></li><li><a href="#space-overhead-of-conservative-gc" class="table-of-contents__link toc-highlight">Space overhead of conservative GC</a><ul><li><a href="#ä¿å®ˆgcçš„ç©ºé—´å¼€é”€" class="table-of-contents__link toc-highlight">ä¿å®ˆ<code>GC</code>çš„ç©ºé—´å¼€é”€</a></li></ul></li><li><a href="#conclusions" class="table-of-contents__link toc-highlight">Conclusions</a><ul><li><a href="#ç»“è®º" class="table-of-contents__link toc-highlight">ç»“è®º</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.143b31b0.js"></script>
<script src="/assets/js/main.cabcfe72.js"></script>
</body>
</html>